<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Sunburst7">
    
    <title>
        
            JSæ·±å…¥å­¦ä¹ (20)ï¼šPromiseçš„æ¨¡æ‹Ÿå®ç° |
        
        Sunburst7&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/blog.svg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"sunburst7.github.io","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/å¸Œéœ²è².jpg","favicon":"/images/blog.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"éå±¥åŸå±±ä¸æ±‚ä»™ï¼Œç‹¬ç¾‡èŠ±æœˆæ¬²ç©·å¹´ï¼Œä¸€ç½¢æ·æ¯ç§‹æ³“é¥®ï¼Œèƒœå´é’é”‹åä¸‰å¼¦ã€‚"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":false},"lazyload":{"enable":true},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/cat50.svg">
                </a>
            
            <a class="logo-title" href="/">
                Sunburst7&#39;s Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                é¦–é¡µ
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                æ—¶é—´çº¿
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                åˆ†ç±»
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tag"
                            >
                                æ ‡ç­¾
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                å…³äº
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">é¦–é¡µ</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">æ—¶é—´çº¿</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">åˆ†ç±»</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tag">æ ‡ç­¾</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">å…³äº</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">JSæ·±å…¥å­¦ä¹ (20)ï¼šPromiseçš„æ¨¡æ‹Ÿå®ç°</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/%E5%B8%8C%E9%9C%B2%E8%8F%B2.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Sunburst7</span>
                        
                            <span class="author-label">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2022-02-08 15:24:04</span>
        <span class="mobile">2022-02-08 15:24</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/JavaScript/">JavaScript</a>&nbsp;
                    </li>
                
                    <li>
                        &gt; <a href="/categories/JavaScript/JS%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/">JSæ·±å…¥å­¦ä¹ </a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/JavaScript/">JavaScript</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E5%89%8D%E7%AB%AF/">å‰ç«¯</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/">æ¨¡æ‹Ÿå®ç°</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>17.1k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>79 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>æœ¬æ–‡<strong>è½¬è½½</strong>ä¸€ç§å°è¯•æ ¹æ®PromiseA+è§„èŒƒå®ç°ä¸€ä¸ªèƒ½é€šè¿‡æ‰€æœ‰Test caseçš„Promiseç±»ã€‚</p>
<ul>
<li>è¯¦ç»†çš„PromiseA+è§„èŒƒåœ¨è¿™é‡Œï¼š<a class="link"   target="_blank" rel="noopener" href="https://promisesaplus.com/" >Promises/A+ (promisesaplus.com)<i class="fas fa-external-link-alt"></i></a></li>
<li>ä¸­æ–‡ç‰ˆï¼š<a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/wangjiachen666/p/11261091.html" >Promise A+ è§„èŒƒã€ä¸­æ–‡ç‰ˆã€‘ - éš¾å‡‰çƒ­è¡€ï¼Œç æ¢¦ä¸ºç”Ÿï¼ - åšå®¢å›­ (cnblogs.com)<i class="fas fa-external-link-alt"></i></a></li>
<li>è½¬è½½åšå®¢ï¼š<a class="link"   target="_blank" rel="noopener" href="https://github.com/yuanyuanbyte/Blog/issues/125" >JavaScript æ·±å…¥ç³»åˆ—ä¹‹ Promise æ ¸å¿ƒåŸç†çš„æ¨¡æ‹Ÿå®ç°ï¼Œé€šè¿‡ Promises/A+ å®˜æ–¹872ä¸ªæµ‹è¯•ç”¨ä¾‹ Â· Issue #125 Â· yuanyuanbyte/Blog (github.com)<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<h1 id="ä¸€ã€å®šä¹‰åˆå§‹ç»“æ„"><a href="#ä¸€ã€å®šä¹‰åˆå§‹ç»“æ„" class="headerlink" title="ä¸€ã€å®šä¹‰åˆå§‹ç»“æ„"></a>ä¸€ã€å®šä¹‰åˆå§‹ç»“æ„</h1><p>åŸç”Ÿçš„promiseæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šç”¨newæ¥åˆ›å»ºå®ä¾‹ ğŸ‘‡ ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>()</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬æ‰‹å†™çš„æ—¶å€™å¯ä»¥ç”¨æ„é€ å‡½æ•°æˆ–è€…classæ¥åˆ›å»ºï¼Œä¸ºäº†æ–¹ä¾¿ä»£ç çš„æ•´ä½“è§‚çœ‹å°±ç”¨classã€‚æŠŠæˆ‘ä»¬æ‰‹å†™çš„Promiseå‘½åä¸ºmyPromiseï¼Œå…·ä½“åå­—å¯ä»¥æŒ‰è‡ªå·±æƒ³æ³•ï¼Œéƒ½å¯ä»¥</p>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª<code>myPromise</code>ç±»</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨newä¸€ä¸ªpromiseå®ä¾‹çš„æ—¶å€™è‚¯å®šæ˜¯éœ€è¦ä¼ å…¥å‚æ•°çš„</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">() =&gt;</span> &#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>ä¸ç„¶è¿™ä¸ªå®ä¾‹ç”¨å¤„ä¸å¤§ï¼›è€Œè¿™ä¸ªå‚æ•°æˆ‘ä»¬çŸ¥é“æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”å½“æˆ‘ä»¬ä¼ å…¥è¿™ä¸ªå‡½æ•°å‚æ•°çš„æ—¶å€™ï¼Œè¿™ä¸ªå‡½æ•°å‚æ•°ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç±»çš„<code>æ„é€ å‡½æ•°constructor</code>é‡Œé¢æ·»åŠ ä¸€ä¸ªå‚æ•°ï¼Œè¿™é‡Œå°±ç”¨funcæ¥åšå½¢å‚ï¼Œå¹¶ä¸”æ‰§è¡Œä¸€ä¸‹è¿™ä¸ªå‚æ•°</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">+    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">+       func();</span><br><span class="line">+   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="äºŒã€å®ç°-resolve-å’Œ-reject"><a href="#äºŒã€å®ç°-resolve-å’Œ-reject" class="headerlink" title="äºŒã€å®ç° resolve å’Œ reject"></a>äºŒã€å®ç° resolve å’Œ reject</h1><p>æ¥ä¸‹æ¥ï¼Œå¤§å®¶éƒ½çŸ¥é“éœ€è¦ä¸ºè¿™ä¸ªå‡½æ•°å‚æ•°ä¼ å…¥å®ƒè‡ªå·±çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯<code>resolve()</code>å’Œ<code>reject()</code></p>
<p>åŸç”Ÿçš„promiseé‡Œé¢å¯ä»¥ä¼ å…¥<code>resolve</code>å’Œ<code>reject</code>ä¸¤ä¸ªå‚æ•°</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¾—å…è®¸æ‰‹å†™è¿™è¾¹å¯ä»¥ä¼ å…¥è¿™ä¸¤ä¸ªå‚æ•°ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">       func(resolve, reject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè¿™æ ·å†™æ˜æ˜¾æœ‰ä¸€ä¸ªé—®é¢˜ ğŸ¤¨ï¼Œé‚£å°±æ˜¯æ‰‹å†™è¿™è¾¹ä¸çŸ¥é“å“ªé‡Œè°ƒç”¨<code>resolve()</code>å’Œ<code>reject()</code>è¿™ä¸¤ä¸ªå‚æ•°ï¼Œæ¯•ç«Ÿ<code>resolve()</code>å’Œ<code>reject()</code>è¿˜æ²¡æœ‰å®šä¹‰ã€‚å› æ­¤å°±éœ€è¦åˆ›é€ å‡ºè¿™ä¸¤ä¸ªå¯¹è±¡ ğŸ˜€</p>
<p>æˆ‘ä»¬éœ€è¦ç”¨<code>this</code>æ¥è°ƒç”¨è‡ªèº«<code>class</code>çš„æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨æ„é€ å‡½æ•°é‡ŒæŠŠä¸¤ä¸ªå‚æ•°å‰åŠ ä¸Š<code>this</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class myPromise &#123;</span><br><span class="line">    constructor(func) &#123;</span><br><span class="line">+       func(this.resolve, this.reject);</span><br><span class="line">    &#125;</span><br><span class="line">    resolve() &#123;&#125;</span><br><span class="line">    reject() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/02/08/JS-Promise%E7%9A%84%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f66376339666363306238356134326435393738616134373533313036653332632e706e67.png"
                      class=""
                >

<p>é‚£ä¹ˆè¿™é‡Œçš„<code>resolve()</code>å’Œ<code>reject()</code>æ–¹æ³•åº”è¯¥å¦‚ä½•æ‰§è¡Œå‘¢ï¼Ÿé‡Œé¢åº”è¯¥å†™ä»€ä¹ˆå†…å®¹å‘¢ï¼ŸğŸ˜¯</p>
<p>è¿™å°±éœ€è¦ç”¨åˆ°çŠ¶æ€äº† ğŸ˜›</p>
<h2 id="1-ç®¡ç†çŠ¶æ€å’Œç»“æœ"><a href="#1-ç®¡ç†çŠ¶æ€å’Œç»“æœ" class="headerlink" title="1. ç®¡ç†çŠ¶æ€å’Œç»“æœ"></a>1. ç®¡ç†çŠ¶æ€å’Œç»“æœ</h2><p>promiseæœ‰ä¸‰ç§çŠ¶æ€ï¼šåˆ†åˆ«æ˜¯<code>pending</code>ï¼Œ<code>fulfilled</code>å’Œ<code>rejected</code></p>
<ul>
<li>åˆå§‹çš„æ—¶å€™æ˜¯<code>pending</code></li>
<li><code>pending</code>å¯ä»¥è½¬ä¸º<code>fulfilled</code>çŠ¶æ€ï¼Œä½†æ˜¯ä¸èƒ½é€†è½¬</li>
<li><code>pending</code>ä¹Ÿå¯ä»¥è½¬ä¸º<code>rejected</code>çŠ¶æ€ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½é€†è½¬</li>
<li>è¿™é‡Œ<code>fulfilled</code>å’Œ<code>rejected</code>ä¹Ÿä¸èƒ½äº’è½¬</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/02/08/JS-Promise%E7%9A%84%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/image-20220208125915659.png"
                      class="" title="image-20220208125915659"
                >

<p>å› æ­¤æˆ‘ä»¬éœ€è¦æå‰å…ˆæŠŠè¿™äº›çŠ¶æ€å®šä¹‰å¥½ï¼Œå¯ä»¥ç”¨<code>const</code>æ¥åˆ›å»ºå¤–éƒ¨çš„å›ºå®šå˜é‡ï¼Œä½†æ˜¯è¿™é‡Œä¸ºäº†ç»Ÿä¸€å°±ç”¨<code>static</code>æ¥åˆ›å»º<code>é™æ€å±æ€§</code>ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">+   <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">+   <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">+   <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        func(<span class="built_in">this</span>.resolve, <span class="built_in">this</span>.reject);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºäº†çŠ¶æ€å±æ€§ä»¥åï¼Œè¿˜éœ€è¦ä¸ºæ¯ä¸€ä¸ªå®ä¾‹æ·»åŠ ä¸€ä¸ª<code>çŠ¶æ€å±æ€§</code>ï¼ŒåŸç”ŸPromiseç”¨<code>PromiseState</code>è¿™ä¸ªå­—æ®µæ¥ä¿å­˜å®ä¾‹çš„çŠ¶æ€å±æ€§ï¼Œè¿™é‡Œå°±ä¹Ÿç”¨ <code>this.PromiseState</code> æ¥ä¿å­˜å®ä¾‹çš„çŠ¶æ€å±æ€§ï¼Œè¿™ä¸ªçŠ¶æ€å±æ€§é»˜è®¤å°±æ˜¯ <code>å¾…å®špending</code> çŠ¶æ€ï¼Œ<strong>è¿™æ ·åœ¨æ¯ä¸€ä¸ªå®ä¾‹è¢«åˆ›å»ºä»¥åå°±ä¼šæœ‰è‡ªèº«çš„çŠ¶æ€å±æ€§å¯ä»¥è¿›è¡Œåˆ¤æ–­å’Œå˜åŠ¨äº†</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">+       <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        func(<span class="built_in">this</span>.resolve, <span class="built_in">this</span>.reject);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆåœ¨æ‰§è¡Œ<code>resolve()</code>çš„æ—¶å€™å°±éœ€è¦åˆ¤æ–­çŠ¶æ€æ˜¯å¦ä¸º <code>å¾…å®š pending</code>ï¼Œå¦‚æœæ˜¯ <code>å¾…å®š pending</code>çš„è¯å°±æŠŠçŠ¶æ€æ”¹ä¸º <code>æˆåŠŸ fulfilled</code>ï¼Œ<code>reject()</code>åŒç†</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        func(<span class="built_in">this</span>.resolve, <span class="built_in">this</span>.reject);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">+       <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">+           <span class="built_in">this</span>.PromiseState = myPromise.REJECT;</span><br><span class="line">+       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>â—¾ æ‰§è¡Œ <code>resolve()</code> å’Œ <code>reject()</code> å¯ä»¥ä¼ å‚</strong></p>
<p>ç°åœ¨æˆ‘ä»¬å†å›å¿†ä¸€ä¸‹åŸç”Ÿ<code>Promise</code> ğŸ™‚ï¼Œåœ¨æ‰§è¡Œ<code>resolve()</code>æˆ–è€…<code>reject()</code>çš„æ—¶å€™éƒ½æ˜¯å¯ä»¥ä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œè¿™æ ·æˆ‘ä»¬åé¢å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‚æ•°äº†</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªç»“æœå‚æ•°å‘½åä¸º<code>PromiseResult</code> *(å’ŒåŸç”ŸPromiseä¿æŒä¸€è‡´)*ï¼Œä¸ç®¡æ˜¯æˆåŠŸè¿˜æ˜¯æ‹’ç»çš„ç»“æœï¼Œä¸¤è€…é€‰å…¶ä¸€ï¼Œæˆ‘ä»¬è®©æ¯ä¸ªå®ä¾‹éƒ½æœ‰<code>PromiseResult</code>å±æ€§ï¼Œå¹¶ä¸”ç»™ä»–ä»¬éƒ½èµ‹å€¼<code>null</code>ï¼Œè¿™é‡Œç»™ç©ºå€¼<code>null</code>æ˜¯å› ä¸ºæ‰§è¡Œ<code>resolve()</code>æˆ–è€…<code>reject()</code>çš„æ—¶å€™ä¼šç»™ç»“æœèµ‹å€¼ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">+       <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        func(<span class="built_in">this</span>.resolve, <span class="built_in">this</span>.reject);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.REJECT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€æˆ‘ä»¬å°±å¯ä»¥ç»™<code>resolve()/reject()</code>æ·»åŠ å‚æ•°ï¼Œå¹¶ä¸”æŠŠå‚æ•°èµ‹å€¼ç»™å®ä¾‹çš„<code>PromiseResult</code>å±æ€§:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        func(<span class="built_in">this</span>.resolve, <span class="built_in">this</span>.reject);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">+   <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.REJECT;</span><br><span class="line">+           <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-this-æŒ‡å‘é—®é¢˜"><a href="#2-this-æŒ‡å‘é—®é¢˜" class="headerlink" title="2. this æŒ‡å‘é—®é¢˜"></a>2. this æŒ‡å‘é—®é¢˜</h2><p>ç°åœ¨çš„ä»£ç çœ‹èµ·æ¥é£å¹³æµªé™çš„ï¼Œä½†å¾ˆå¤šäººä¼šåœ¨è¿™é‡ŒçŠ¯é”™~ğŸ˜¥å¤§å®¶è§‰å¾—è¿™é‡Œæœ‰ä»€ä¹ˆé”™è¯¯ï¼ŸğŸ§</p>
<p>æˆ‘ä»¬æ¥<code>new</code>ä¸€ä¸ªå®ä¾‹ ğŸŒ° æ‰§è¡Œä¸€ä¸‹ä»£ç å°±çŸ¥é“æœ‰æ²¡æœ‰é—®é¢˜äº†</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        func(<span class="built_in">this</span>.resolve, <span class="built_in">this</span>.reject);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.REJECT;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line">+  <span class="keyword">let</span> promise1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">+      resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">+  &#125;)</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä¸Šé¢ä»£ç ï¼ŒæŠ¥é”™ ğŸ¦ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Uncaught TypeError: Cannot read property &#x27;PromiseState &#x27; of undefined</span><br></pre></td></tr></table></figure>

<p>å¯ä»æŠ¥é”™çš„ä¿¡æ¯é‡Œé¢æˆ‘ä»¬è²Œä¼¼å‘ç°ä¸äº†æœ‰ä»€ä¹ˆé”™è¯¯ğŸ¤¨ï¼Œå› ä¸º<code>PromiseState </code>å±æ€§æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ï¼Œä¸åº”è¯¥æ˜¯<code>undefined</code>~</p>
<p>åŸä½œè€…çš„è§£é‡Šå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>ğŸ” ä½†æˆ‘ä»¬ä»”ç»†çœ‹çœ‹<code>resolve()</code>å’Œ<code>reject()</code>æ–¹æ³•é‡Œè°ƒç”¨<code>PromiseState </code>ï¼Œå‰é¢æ˜¯æœ‰<code>this</code>å…³é”®å­—çš„ğŸ˜²</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    resolve(result) &#123;</span><br><span class="line">â¡      if (this.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">â¡          this.PromiseState = myPromise.FULFILLED;</span><br><span class="line">            this.PromiseResult = result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    reject(reason) &#123;</span><br><span class="line">â¡      if (this.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">â¡          this.PromiseState = myPromise.REJECT;</span><br><span class="line">            this.PromiseResult = reason;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆåªæœ‰ä¸€ç§å¯èƒ½ğŸ§ï¼Œè°ƒç”¨<code>this.PromiseState </code>çš„æ—¶å€™å¹¶æ²¡æœ‰è°ƒç”¨<code>constructor</code>é‡Œçš„<code>this.PromiseState </code>ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„<code>this</code>å·²ç»è·Ÿä¸¢äº†~</p>
<p>æˆ‘ä»¬åœ¨<code>new</code>ä¸€ä¸ªæ–°å®ä¾‹çš„æ—¶å€™æ‰§è¡Œçš„æ˜¯<code>constructor</code>é‡Œçš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯<code>constructor</code>é‡Œçš„<code>this</code>ç¡®å®æ˜¯æ–°å®ä¾‹çš„ï¼Œä½†ç°åœ¨æˆ‘ä»¬æ˜¯åœ¨æ–°å®ä¾‹è¢«åˆ›å»ºåå†åœ¨å¤–éƒ¨ç¯å¢ƒä¸‹æ‰§è¡Œ<code>resolve()</code>æ–¹æ³•çš„ï¼Œè¿™é‡Œçš„<code>resolve()</code>çœ‹ç€åƒæ˜¯å’Œå®ä¾‹ä¸€èµ·æ‰§è¡Œçš„ï¼Œå…¶å®ä¸ç„¶ï¼Œä¹Ÿå°±<strong>ç›¸å½“äºä¸åœ¨<code>class</code>å†…éƒ¨ä½¿ç”¨è¿™ä¸ª<code>this</code><strong>ï¼Œè€Œ</strong>æˆ‘ä»¬æ²¡æœ‰åœ¨å¤–éƒ¨å®šä¹‰ä»»ä½•<code>PromiseState </code>å˜é‡ï¼Œå› æ­¤è¿™é‡Œä¼šæŠ¥é”™</strong></p>
</blockquote>
<p>æˆ‘è§‰å¾—å¯ä»¥è¿™æ ·è§£é‡Šï¼Œå› ä¸ºfuncå£°æ˜çš„æ—¶å€™æ˜¯ç”¨ç®­å¤´å‡½æ•°å£°æ˜ï¼Œè€Œç®­å¤´å‡½æ•°çš„ä½œç”¨åŸŸæŒ‡å‘çˆ¶ä½œç”¨åŸŸï¼Œä¹Ÿå°±æ˜¯å…¨å±€ä½œç”¨åŸŸï¼Œè€Œå…¨å±€ä¸­æ²¡æœ‰promiseStateå˜é‡ï¼Œå› æ­¤ä¼šæŠ¥undefinedã€‚</p>
<p>è§£å†³<code>class</code>çš„<code>this</code>æŒ‡å‘é—®é¢˜ä¸€èˆ¬ä¼šç”¨ç®­å¤´å‡½æ•°æˆ–è€…<code>bind</code>ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨<code>bind</code>æ¥ç»‘å®š<code>this</code>ï¼Œåªéœ€è¦åœ¨æ„é€ å‡½æ•°<code>constructor</code>ä¸­çš„<code>this.resolve</code>å’Œ<code>this.reject</code>ååŠ ä¸Šï¼Œ<code>.bindï¼ˆthisï¼‰</code>å°±å¯ä»¥äº† ğŸ˜º:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">+       func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">        <span class="comment">// æˆ–è€…å°†resolveä¸rejectå®šä¹‰åœ¨constructorä¸­</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult  = result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.REJECT;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>å¯¹äº<code>resolve/reject</code>æ¥è¯´ï¼Œè¿™é‡Œå°±æ˜¯ç»™å®ä¾‹çš„<code>resolve()/reject()</code>æ–¹æ³•ç»‘å®šè¿™ä¸ª<code>this</code>ä¸ºå½“å‰çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶ä¸”æ‰§è¡Œ<code>this.resolve()</code>æ–¹æ³•ï¼š</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/02/08/JS-Promise%E7%9A%84%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/image-20220208130830983.png"
                      class="" title="image-20220208130830983"
                >

<p>å’±ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ä»£ç å§ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(promise1); </span><br><span class="line"><span class="comment">// myPromise &#123;PromiseState: &#x27;fulfilled&#x27;, PromiseResult: &#x27;è¿™æ¬¡ä¸€å®š&#x27;&#125;</span></span><br><span class="line"><span class="keyword">let</span> promise2 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    reject(<span class="string">&#x27;ä¸‹æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(promise2); </span><br><span class="line"><span class="comment">// myPromise &#123;PromiseState: &#x27;rejected&#x27;, PromiseResult: &#x27;ä¸‹æ¬¡ä¸€å®š&#x27;&#125;</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯æˆ‘ä»¬æ‰‹å†™çš„ <code>myPromise</code>çš„æ‰§è¡Œæƒ…å†µï¼Œçœ‹çœ‹åŸç”ŸPromiseçš„æ‰§è¡Œæƒ…å†µï¼š</p>
<p>è¯´æ˜æ‰§è¡Œç»“æœç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œæ˜¯ä¸æ˜¯è§‰å¾—ç¦»æˆåŠŸåˆè¿›äº†ä¸€æ­¥å•¦~ ğŸ‘ğŸ‘ğŸ‘</p>
<p>é‚£ä¹ˆå¤§å®¶è§‰å¾—ä¸‹ä¸€æ­¥æˆ‘ä»¬è¦åšä»€ä¹ˆï¼Ÿæ˜¯ä¸æ˜¯å¾ˆå¤šåŒå­¦è§‰å¾—éœ€è¦å†™<code>then</code>äº†ï¼Ÿé‚£ä¹ˆæˆ‘ä»¬å°±å…ˆæ¥æ»¡è¶³æƒ³è¦å†™<code>then</code>çš„åŒå­¦ä»¬~</p>
<h1 id="ä¸‰ã€å®ç°-then-æ–¹æ³•"><a href="#ä¸‰ã€å®ç°-then-æ–¹æ³•" class="headerlink" title="ä¸‰ã€å®ç° then æ–¹æ³•"></a>ä¸‰ã€å®ç° then æ–¹æ³•</h1><p><strong>å› ä¸º<code>then</code>æ˜¯åœ¨åˆ›å»ºå®ä¾‹åå†è¿›è¡Œè°ƒç”¨çš„ï¼Œå› æ­¤æˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ªç±»æ–¹æ³•ï¼Œå¯åƒä¸‡ä¸è¦åˆ›å»ºåœ¨ <code>constructor</code> é‡Œé¢äº†~ğŸ˜›</strong></p>
<p><code>then</code>æ–¹æ³•å¯ä»¥ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œè¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯å½“çŠ¶æ€ä¸º<code>fulfilled æˆåŠŸ</code> æ—¶æ‰§è¡Œçš„ä»£ç ï¼Œå¦ä¸€ä¸ªæ˜¯å½“çŠ¶æ€ä¸º <code>rejected æ‹’ç»</code> æ—¶æ‰§è¡Œçš„ä»£ç ã€‚</p>
<p>å› æ­¤æˆ‘ä»¬å°±å¯ä»¥å…ˆç»™æ‰‹å†™çš„<code>then</code>é‡Œé¢æ·»åŠ  <strong>ä¸¤ä¸ªå‚æ•°</strong>ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ˜¯ <code>onFulfilled</code> è¡¨ç¤º <code>â€œå½“çŠ¶æ€ä¸ºæˆåŠŸæ—¶â€</code></li>
<li>å¦ä¸€ä¸ªæ˜¯ <code>onRejected</code> è¡¨ç¤º <code>â€œå½“çŠ¶æ€ä¸ºæ‹’ç»æ—¶â€</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">+   <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-çŠ¶æ€ä¸å¯å˜"><a href="#1-çŠ¶æ€ä¸å¯å˜" class="headerlink" title="1. çŠ¶æ€ä¸å¯å˜"></a>1. çŠ¶æ€ä¸å¯å˜</h2><p>è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹çœ‹<code>åŸç”Ÿ Promise</code> äº§ç”Ÿçš„ç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">let promise = new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">    resolve(&#x27;è¿™æ¬¡ä¸€å®š&#x27;)</span><br><span class="line">    reject(&#x27;ä¸‹æ¬¡ä¸€å®š&#x27;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">promise.then(</span><br><span class="line">    result =&gt; &#123;</span><br><span class="line">        console.log(&#x27;fulfilled&#x27;, result);</span><br><span class="line">    &#125;,</span><br><span class="line">    reason =&gt; &#123;</span><br><span class="line">        console.log(&#x27;rejected&#x27;, reason.message);</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/02/08/JS-Promise%E7%9A%84%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/image-20220208132632981.png"
                      class="" title="image-20220208132632981"
                >

<p>å¯ä»¥çœ‹åˆ°æ§åˆ¶å°åªæ˜¾ç¤ºäº†ä¸€ä¸ª<code>console.log</code>çš„ç»“æœï¼Œ<strong>è¯æ˜ <code>Promise</code> åªä¼šæ‰§è¡Œ<code>æˆåŠŸçŠ¶æ€</code> æˆ–è€… <code>æ‹’ç»çŠ¶æ€</code> çš„å…¶ä¸­ä¸€ä¸ª</strong></p>
<p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰æ–‡è®²åˆ°çš„ï¼Œ<code>Promise</code> åªä»¥ <code>ç¬¬ä¸€æ¬¡ä¸ºå‡†</code>ï¼Œç¬¬ä¸€æ¬¡æˆåŠŸå°±<code>æ°¸ä¹…</code>ä¸º<code>fulfilled</code>ï¼Œç¬¬ä¸€æ¬¡å¤±è´¥å°±<code>æ°¸è¿œ</code>çŠ¶æ€ä¸º<code>rejected</code></p>
<p>å› æ­¤æˆ‘ä»¬åœ¨æ‰‹å†™çš„æ—¶å€™å°±å¿…é¡»è¿›è¡Œåˆ¤æ–­ ğŸ¤–ï¼š</p>
<p>â—¾ å¦‚æœå½“å‰å®ä¾‹çš„ <code>PromiseState</code> çŠ¶æ€å±æ€§ä¸º <code>fulfilled æˆåŠŸ </code>çš„è¯ï¼Œæˆ‘ä»¬å°±æ‰§è¡Œä¼ è¿›æ¥çš„ <code>onFulfilled</code> å‡½æ•°ï¼Œå¹¶ä¸”ä¸º<code>onFulfilled</code>å‡½æ•°ä¼ å…¥å‰é¢ä¿ç•™çš„<code>PromiseResult</code>å±æ€§å€¼ï¼š</p>
<p>â—¾ å¦‚æœå½“å‰å®ä¾‹çš„ <code>PromiseState</code> çŠ¶æ€å±æ€§ä¸º <code>rejected æ‹’ç»</code> çš„è¯ï¼Œæˆ‘ä»¬å°±æ‰§è¡Œä¼ è¿›æ¥çš„ <code>onRejected</code> å‡½æ•°ï¼Œå¹¶ä¸”ä¸º<code>onRejected</code>å‡½æ•°ä¼ å…¥å‰é¢ä¿ç•™çš„<code>PromiseResult</code>å±æ€§å€¼ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myProise.FULFILLED) &#123;</span><br><span class="line">            onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">           onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰å¥½äº†åˆ¤æ–­æ¡ä»¶ä»¥åï¼Œæˆ‘ä»¬å°±æ¥æµ‹è¯•ä¸€ä¸‹ä»£ç ï¼Œä¹Ÿæ˜¯ä¸€æ ·ï¼Œåœ¨å®ä¾‹ ğŸŒ° ä¸Šä½¿ç”¨<code>then</code>æ–¹æ³•ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">    reject(<span class="string">&#x27;ä¸‹æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">promise1.then(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(result)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(reason.message)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¸Šé¢çš„æµ‹è¯•ä»£ç ï¼ŒæŸ¥çœ‹æ§åˆ¶å°ï¼š</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/02/08/JS-Promise%E7%9A%84%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/image-20220208132757532.png"
                      class="" title="image-20220208132757532"
                >

<p>å¯ä»¥çœ‹åˆ°æ§åˆ¶å°åªæ˜¾ç¤ºäº†ä¸€ä¸ª<code>console.log</code>çš„ç»“æœï¼š<code>è¿™æ¬¡ä¸€å®š</code> ğŸ˜ï¼Œè¯æ˜æˆ‘ä»¬å·²ç»å®ç°äº† <code>promiseçš„çŠ¶æ€ä¸å¯å˜</code> ğŸ‘ğŸ‘ğŸ‘</p>
<h2 id="2-æ‰§è¡Œå¼‚å¸¸-throw"><a href="#2-æ‰§è¡Œå¼‚å¸¸-throw" class="headerlink" title="2. æ‰§è¡Œå¼‚å¸¸ throw"></a>2. æ‰§è¡Œå¼‚å¸¸ throw</h2><p>åœ¨<code>new Promise</code>çš„æ—¶å€™ï¼Œæ‰§è¡Œå‡½æ•°é‡Œé¢å¦‚æœæŠ›å‡ºé”™è¯¯ï¼Œæ˜¯ä¼šè§¦å‘<code>then</code>æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå³<code>rejected</code>çŠ¶æ€çš„å›è°ƒå‡½æ•°</p>
<p>ä¹Ÿå°±æ˜¯åœ¨åŸç”Ÿçš„Promiseé‡Œé¢ï¼Œ<code>then</code>æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå³<code>rejected</code>çŠ¶æ€çš„å›è°ƒå‡½æ•°å¯ä»¥æŠŠé”™è¯¯çš„ä¿¡æ¯ä½œä¸ºå†…å®¹è¾“å‡ºå‡ºæ¥</p>
<p>åˆ°è¿™é‡Œï¼Œæœ‰çš„åŒå­¦å¯èƒ½ä¼šè¯´ï¼Œæ‰§è¡Œå¼‚å¸¸æŠ›é”™ï¼Œä¸æ˜¯ç”¨<code>catch()</code>æ–¹æ³•å»æ¥å—ï¼Ÿä¸ºä»€ä¹ˆè¿™é‡Œåˆè¯´ <code>æ˜¯ä¼šè§¦å‘thenæ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå³rejectedçŠ¶æ€çš„å›è°ƒå‡½æ•°</code>ï¼ŸğŸ˜µ</p>
<p>é‚£æˆ‘ä»¬å°±è¯´é“è¯´é“å§ğŸ§ï¼š</p>
<p><code>catch()</code> æ–¹æ³•è¿”å›ä¸€ä¸ª<code>Promise</code>ï¼Œå¹¶ä¸”å¤„ç†æ‹’ç»çš„æƒ…å†µã€‚å®ƒçš„è¡Œä¸ºä¸è°ƒç”¨<code>Promise.prototype.then(undefined, onRejected)</code> ç›¸åŒã€‚æˆ‘ä»¬æ˜¾å¼ä½¿ç”¨<code>obj.catch(onRejected)</code>ï¼Œå†…éƒ¨å®é™…è°ƒç”¨çš„æ˜¯<code>obj.then(undefined, onRejected)</code>)</p>
<p><code>Promise.prototype.catch()</code>æ–¹æ³•æ˜¯<code>.then(null, rejection)</code>æˆ–<code>.then(undefined, rejection)</code>çš„åˆ«åï¼Œç”¨äºæŒ‡å®šå‘ç”Ÿé”™è¯¯æ—¶çš„å›è°ƒå‡½æ•°ã€‚</p>
<p>â—¾ æ³¨æ„çœ‹ä¸‹é¢çš„ä¾‹å­ ğŸŒ°ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">promise.catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(error);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Error: test</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»£ç ä¸­ï¼ŒpromiseæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå°±è¢«<code>catch()</code>æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°æ•è·ã€‚æ³¨æ„ï¼Œä¸Šé¢çš„å†™æ³•ä¸ä¸‹é¢ä¸¤ç§å†™æ³•æ˜¯ç­‰ä»·çš„ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†™æ³•ä¸€</span></span><br><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">    reject(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">promise.catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(error);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// å†™æ³•äºŒ</span></span><br><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">  reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;test&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line">promise.catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>æ¯”è¾ƒä¸Šé¢ä¸¤ç§å†™æ³•ï¼Œå¯ä»¥å‘ç°<code>reject()</code>æ–¹æ³•çš„ä½œç”¨ï¼Œç­‰åŒäºæŠ›å‡ºé”™è¯¯ã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºæˆ‘ä»¬æ‰‹å†™Promiseå°±æ˜¯ç”¨<code>try/catch</code>æ¥å¤„ç†å¼‚å¸¸ï¼Œç”¨çš„å°±æ˜¯ä¸Šé¢çš„æ€æƒ³ã€‚</p>
<p>â—¾ <strong>ä¸€èˆ¬æ¥è¯´ï¼Œä¸è¦åœ¨<code>then()</code>æ–¹æ³•é‡Œé¢å®šä¹‰ Reject çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼ˆå³<code>then</code>çš„ç¬¬äºŒä¸ªå‚æ•°ï¼‰ï¼Œæ€»æ˜¯ä½¿ç”¨<code>catch</code>æ–¹æ³•ã€‚</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line">promise</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// success</span></span><br><span class="line">  &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// error</span></span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line"><span class="comment">// good</span></span><br><span class="line">promise</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123; <span class="comment">//cb</span></span><br><span class="line">    <span class="comment">// success</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// error</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬äºŒç§å†™æ³•è¦å¥½äºç¬¬ä¸€ç§å†™æ³•ï¼Œç†ç”±æ˜¯ç¬¬äºŒç§å†™æ³•å¯ä»¥æ•è·å‰é¢<code>then</code>æ–¹æ³•æ‰§è¡Œä¸­çš„é”™è¯¯ï¼Œä¹Ÿæ›´æ¥è¿‘åŒæ­¥çš„å†™æ³•ï¼ˆ<code>try/catch</code>ï¼‰ã€‚å› æ­¤ï¼Œå»ºè®®æ€»æ˜¯ä½¿ç”¨<code>catch()</code>æ–¹æ³•ï¼Œè€Œä¸ä½¿ç”¨<code>then()</code>æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚</p>
<p><strong>å›åˆ°æ­£é¢˜</strong></p>
<p>â—¾ æˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œ<code>resolve()</code>å’Œ<code>reject()</code>ä¹‹å‰ç”¨<code>try/catch</code>è¿›è¡Œåˆ¤æ–­ï¼Œåœ¨<code>æ„é€ å‡½æ•° constructor</code>é‡Œé¢å®Œå–„ä»£ç ï¼Œåˆ¤æ–­ç”Ÿæˆå®ä¾‹çš„æ—¶å€™æ˜¯å¦æœ‰æŠ¥é”™ ğŸ”ï¼š</p>
<ul>
<li>å¦‚æœæ²¡æœ‰æŠ¥é”™çš„è¯ï¼Œå°±æŒ‰ç…§æ­£å¸¸æ‰§è¡Œ<code>resolve()</code>å’Œ<code>reject()</code>æ–¹æ³•</li>
<li>å¦‚æœæŠ¥é”™çš„è¯ï¼Œå°±æŠŠé”™è¯¯ä¿¡æ¯ä¼ å…¥ç»™<code>reject()</code>æ–¹æ³•ï¼Œå¹¶ä¸”ç›´æ¥æ‰§è¡Œ<code>reject()</code>æ–¹æ³•</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">+       <span class="keyword">try</span> &#123;</span><br><span class="line">            func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">+       &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">+           <span class="built_in">this</span>.reject(error)</span><br><span class="line">+       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;ç™½å«–ä¸æˆåŠŸ&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">promise1.then(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;fulfiiled:&#x27;</span>, result)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;rejected:&#x27;</span>, reason)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>â—¾ <strong>æ³¨æ„è¿™é‡Œä¸éœ€è¦ç»™<code>reject()</code>æ–¹æ³•è¿›è¡Œ<code>this</code>çš„ç»‘å®šäº†ï¼Œå› ä¸ºè¿™é‡Œæ˜¯ç›´æ¥æ‰§è¡Œï¼Œè€Œä¸æ˜¯åˆ›å»ºå®ä¾‹åå†æ‰§è¡Œã€‚</strong></p>
<p>â—¾ è¿™é‡Œè€ƒå¯Ÿäº†<code>this</code>ç»‘å®šçš„ä¸€ä¸ªç»†èŠ‚ğŸ”ï¼š<code>call</code>ã€<code>apply</code>å’Œ<code>bind</code>éƒ½å¯ä»¥æ”¹å˜å‡½æ•°ä½“å†…éƒ¨ this çš„æŒ‡å‘ï¼Œ<strong>ä½†æ˜¯ <code>bind</code> å’Œ <code>call/apply</code> æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åŒºåˆ«ï¼šä¸€ä¸ªå‡½æ•°è¢« <code>call/apply</code> çš„æ—¶å€™ï¼Œä¼šç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œä½†æ˜¯ <code>bind</code> ä¼šåˆ›å»ºä¸€ä¸ªæ–°å‡½æ•°ï¼Œä¸ä¼šç«‹å³æ‰§è¡Œã€‚</strong>è¿™å°±æ˜¯å‰é¢ä¸ºä»€ä¹ˆè¯´ï¼Œ<code> this.reject.bind(this)</code>åªæ˜¯ä½œä¸ºå‚æ•°ï¼Œå¹¶æ²¡æœ‰ç›´æ¥æ‰§è¡Œçš„åŸå› äº†~ğŸ˜€</p>
<p><strong>å›åˆ°æ­£æ–‡</strong></p>
<p>ç»“åˆå‰é¢çš„è®²è§£ï¼Œåˆ·æ–°ä¸€ä¸‹æ§åˆ¶å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰‹å†™è¿™è¾¹å·²ç»æ²¡æœ‰æŠ¥é”™äº†ğŸ‘ğŸ‘ğŸ‘:</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/03dddada3cba39cab4631fd454d48bd9d64b0dc24df8f009ac26f20246e4bd97/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f30363163383861623831366634623632383362366439646535666463326265372e706e67"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://camo.githubusercontent.com/03dddada3cba39cab4631fd454d48bd9d64b0dc24df8f009ac26f20246e4bd97/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f30363163383861623831366634623632383362366439646535666463326265372e706e67"
                      alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
                ></a></p>
<h2 id="3-å‚æ•°æ ¡éªŒ"><a href="#3-å‚æ•°æ ¡éªŒ" class="headerlink" title="3. å‚æ•°æ ¡éªŒ"></a>3. å‚æ•°æ ¡éªŒ</h2><p>å¤§å®¶è§‰å¾—ç›®å‰ä»£ç æ˜¯ä¸æ˜¯æ²¡é—®é¢˜äº†ï¼Ÿå¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥äº†ï¼Ÿ</p>
<p>å¦‚æœä½ è§‰å¾—æ˜¯çš„è¯å°±åˆæ‰å‘äº†~ğŸ¦</p>
<p>åŸç”ŸPromiseé‡Œ<strong>è§„å®š<code>then</code>æ–¹æ³•é‡Œé¢çš„ä¸¤ä¸ªå‚æ•°å¦‚æœä¸æ˜¯å‡½æ•°çš„è¯å°±è¦è¢«å¿½ç•¥</strong>ï¼Œæˆ‘ä»¬å°±æ•…æ„åœ¨åŸç”Ÿä»£ç è¿™é‡Œä¸ä¼ å…¥å‡½æ•°ä½œä¸ºå‚æ•°ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;ç™½å«–ä¸æˆåŠŸ&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">promise.then(</span><br><span class="line">    <span class="literal">undefined</span>,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;rejected:&#x27;</span>, reason)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä»¥åæˆ‘ä»¬å‘ç°åœ¨è¿™é‡Œæ‰§è¡Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/32ec82d71001e1eec390dbb212a6f654543565a8f639edd905731caafcd4e8a8/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f30306535653966383835383434316239383835633366353964306161326633382e706e67"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://camo.githubusercontent.com/32ec82d71001e1eec390dbb212a6f654543565a8f639edd905731caafcd4e8a8/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f30306535653966383835383434316239383835633366353964306161326633382e706e67"
                      alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
                ></a></p>
<p>æˆ‘ä»¬å†ä»¥åŒæ ·ç±»ä¼¼çš„ä¸ä¼  <strong>å‡½æ•°å‚æ•°</strong> çš„ä»£ç åº”ç”¨åœ¨ <strong>æ‰‹å†™ä»£ç </strong> ä¸Šé¢ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">promise1.then(</span><br><span class="line">    <span class="literal">undefined</span>,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;rejected:&#x27;</span>, reason)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>å¤§å®¶æƒ³æƒ³ä¼šä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿæ¥çœ‹çœ‹ç»“æœä¼šæ€æ ·ï¼ŸğŸ§</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/bd637667e0aba736981044b19cd3b032957de41f438f67c1b08ea7a23f43b879/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32333230333231633264303734333631623239643037396631653334383461342e706e67"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://camo.githubusercontent.com/bd637667e0aba736981044b19cd3b032957de41f438f67c1b08ea7a23f43b879/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32333230333231633264303734333631623239643037396631653334383461342e706e67"
                      alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
                ></a></p>
<p>ç»“æœå°±æ˜¯ <code>Uncaught TypeError: onFulfilled is not a function</code>ã€‚æµè§ˆå™¨å¸®ä½ æŠ¥é”™äº†ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„~ğŸ˜¥</p>
<p>æˆ‘ä»¬åªæƒ³è¦è‡ªå·±æ¥æŠ›å‡ºé”™è¯¯ï¼Œå†æ¥çœ‹çœ‹åˆšåˆšçš„æ‰‹å†™<code>then</code>éƒ¨åˆ†ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">        onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">        onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¼šåœ¨é‡Œé¢åˆ†åˆ«æ‰§è¡ŒæˆåŠŸå’Œæ‹’ç»ä¸¤ä¸ªå‚æ•°ï¼Œå¯æ˜¯æˆ‘ä»¬ä¸æƒ³ä¿®æ”¹è¿™é‡Œçš„ä»£ç ï¼Œé‚£ä¹ˆå°±åªèƒ½æŠŠä¸æ˜¯å‡½æ•°çš„å‚æ•°æ”¹ä¸ºå‡½æ•°</p>
<p><strong><code>Promise</code> è§„èŒƒå¦‚æœ <code>onFulfilled</code> å’Œ <code>onRejected</code> ä¸æ˜¯å‡½æ•°ï¼Œå°±å¿½ç•¥ä»–ä»¬ï¼Œæ‰€è°“â€œå¿½ç•¥â€å¹¶ä¸æ˜¯ä»€ä¹ˆéƒ½ä¸å¹²ï¼Œå¯¹äº<code>onFulfilled</code>æ¥è¯´â€œå¿½ç•¥â€å°±æ˜¯å°†<code>value</code>åŸå°ä¸åŠ¨çš„è¿”å›ï¼Œå¯¹äº<code>onRejected</code>æ¥è¯´å°±æ˜¯è¿”å›<code>reason</code>ï¼Œ<code>onRejected</code>å› ä¸ºæ˜¯é”™è¯¯åˆ†æ”¯ï¼Œæˆ‘ä»¬è¿”å›<code>reason</code>åº”è¯¥<code>throw</code>ä¸€ä¸ª<code>Error</code>:</strong></p>
<p>è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ <code>æ¡ä»¶è¿ç®—ç¬¦</code>ï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œ<code>if</code>åˆ¤æ–­ä¹‹å‰è¿›è¡Œé¢„å…ˆåˆ¤æ–­ï¼š</p>
<p>â–ª å¦‚æœ<code>onFulfilled</code>å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±æŠŠåŸæ¥çš„<code>onFulfilled</code>å†…å®¹é‡æ–°èµ‹å€¼ç»™å®ƒï¼Œå¦‚æœ<code>onFulfilled</code>å‚æ•°ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±å°†<code>value</code>åŸå°ä¸åŠ¨çš„è¿”å›</p>
<p>â–ª å¦‚æœ<code>onRejected</code>å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±æŠŠåŸæ¥çš„<code>onRejected</code>å†…å®¹é‡æ–°èµ‹å€¼ç»™å®ƒï¼Œå¦‚æœ<code>onRejected</code>å‚æ•°ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±<code>throw</code>ä¸€ä¸ª<code>Error</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">+       onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">+       onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">promise1.then(</span><br><span class="line">    <span class="literal">undefined</span>,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;rejected:&#x27;</span>, reason)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹æ§åˆ¶å°ï¼Œå‘ç°æ²¡æœ‰æŠ¥é”™äº†ğŸ‘ğŸ‘ğŸ‘ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/cb94ec427bf9114195ae2e4d5613fc6f17d6a1db11f0c0288b3837716891eb63/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f30386365636566373961306634373437393866326433363262663432383464302e706e67"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://camo.githubusercontent.com/cb94ec427bf9114195ae2e4d5613fc6f17d6a1db11f0c0288b3837716891eb63/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f30386365636566373961306634373437393866326433363262663432383464302e706e67"
                      alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
                ></a></p>
<p><strong>å½“å‰å®ç°çš„å®Œæ•´ä»£ç ï¼š</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="built_in">this</span>.reject(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="å››ã€å®ç°å¼‚æ­¥"><a href="#å››ã€å®ç°å¼‚æ­¥" class="headerlink" title="å››ã€å®ç°å¼‚æ­¥"></a>å››ã€å®ç°å¼‚æ­¥</h1><h2 id="1-æ·»åŠ å®šæ—¶å™¨"><a href="#1-æ·»åŠ å®šæ—¶å™¨" class="headerlink" title="1. æ·»åŠ å®šæ—¶å™¨"></a>1. æ·»åŠ å®šæ—¶å™¨</h2><p>åœ¨å¯¹ä»£ç è¿›è¡Œä¸€äº›åŸºæœ¬ä¿®è¡¥ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥è¿›è¡Œä¸‹ä¸€ä¸ªå¤§åŠŸèƒ½äº†ï¼Œä¹Ÿå°±æ˜¯Promiseçš„ <strong>å¼‚æ­¥åŠŸèƒ½</strong> âœ¨ã€‚</p>
<p>å¯ä»¥è¯´æˆ‘ä»¬åœ¨æ‰‹å†™çš„ä»£ç é‡Œé¢ä¾æ—§æ²¡æœ‰æ¤å…¥å¼‚æ­¥åŠŸèƒ½ï¼Œæ¯•ç«Ÿæœ€åŸºæœ¬çš„<code>setTimeout</code>æˆ‘ä»¬éƒ½æ²¡æœ‰ä½¿ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»å…ˆäº†è§£ä¸€ä¸‹åŸç”ŸPromiseçš„ä¸€äº›<code>è¿è¡Œé¡ºåºè§„åˆ™</code>ã€‚</p>
<p>åœ¨è¿™é‡Œæˆ‘ä¸ºåŸç”Ÿä»£ç æ·»åŠ ä¸Šæ­¥éª¤ä¿¡æ¯ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">    resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">promise.then(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled:&#x27;</span>, result);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;rejected:&#x27;</span>, reason)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬é…åˆè¿™æ®µåŸç”ŸPromiseä»£ç ï¼Œç»“åˆæ§åˆ¶å°ä¸€èµ·çœ‹çœ‹</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/02/08/JS-Promise%E7%9A%84%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/image-20220208150043589.png"
                      class="" title="image-20220208150043589"
                >

<p>è¾“å‡ºé¡ºåºä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">fulfilled: è¿™æ¬¡ä¸€å®š</span><br></pre></td></tr></table></figure>

<ul>
<li>é¦–å…ˆæ‰§è¡Œ<code>console.log(1)</code>ï¼Œè¾“å‡º<code>1</code></li>
<li>æ¥ç€åˆ›å»º<code>promiseå®ä¾‹</code>ï¼Œè¾“å‡º<code>2</code>ï¼Œå› ä¸ºè¿™é‡Œä¾æ—§æ˜¯åŒæ­¥</li>
<li>ç„¶åç¢°åˆ°<code>resolve</code>çš„æ—¶å€™ï¼Œä¿®æ”¹ç»“æœå€¼</li>
<li>åˆ°äº†<code>promise.then</code>ä¼šè¿›è¡Œå¼‚æ­¥æ“ä½œï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ <strong>éœ€è¦å…ˆæŠŠæ‰§è¡Œæ ˆçš„å†…å®¹æ¸…ç©º</strong>ï¼Œäºæ˜¯å°±æ‰§è¡Œ<code>console.log(3)</code>ï¼Œè¾“å‡º<code>3</code></li>
<li>æ¥ç€æ‰ä¼šæ‰§è¡Œ<code>promise.then</code>é‡Œé¢çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯æœ€åè¾“å‡º<code>â€œfulfilled: è¿™æ¬¡ä¸€å®šâ€</code></li>
</ul>
<p>â–ª æˆ‘ä»¬ç”¨åŒæ ·çš„æµ‹è¯•ä»£ç åº”ç”¨åœ¨ <strong>æ‰‹å†™ä»£ç </strong> ä¸Šé¢ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">    resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">promise1.then(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled:&#x27;</span>, result);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;rejected:&#x27;</span>, reason)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™æ¬¡æˆ‘ä»¬å‘ç°æœ‰äº›ä¸åŒäº†ğŸ˜¯ï¼Œè¾“å‡ºé¡ºåºä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">fulfilled: è¿™æ¬¡ä¸€å®š</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/02/08/JS-Promise%E7%9A%84%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/image-20220208150032763.png"
                      class="" title="image-20220208150032763"
                >

<p><code>1</code> å’Œ <code>2</code> éƒ½æ²¡æœ‰é—®é¢˜ï¼Œé—®é¢˜å°±æ˜¯<code>â€œfulfilled: è¿™æ¬¡ä¸€å®šâ€</code>å’Œ<code>3</code>è¿™é‡Œçš„é¡ºåºä¸å¯¹</p>
<p>â—¾ å…¶å®é—®é¢˜å¾ˆç®€å•ï¼Œå°±æ˜¯æˆ‘ä»¬åˆšåˆšè¯´çš„ <strong>æ²¡æœ‰è®¾ç½®å¼‚æ­¥æ‰§è¡Œ</strong> ğŸ˜¶</p>
<p>æˆ‘ä»¬äºŒè¯ä¸è¯´ç›´æ¥ç»™<code>then</code>æ–¹æ³•é‡Œé¢æ·»åŠ <code>setTimeout</code>å°±å¯ä»¥äº†ğŸ˜ï¼Œ<strong>éœ€è¦åœ¨è¿›è¡Œ<code>if</code>åˆ¤æ–­ä»¥åå†æ·»åŠ <code>setTimeout</code>ï¼Œè¦ä¸ç„¶çŠ¶æ€ä¸ç¬¦åˆæ·»åŠ å¼‚æ­¥ä¹Ÿæ˜¯æ²¡æœ‰æ„ä¹‰çš„</strong>ï¼Œç„¶ååœ¨<code>setTimeout</code>é‡Œæ‰§è¡Œä¼ å…¥çš„å‡½æ•°å‚æ•°ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">+           <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">+           &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">+           <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">+           &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä½¿ç”¨å‰é¢çš„ç”¨ä¾‹é‡æ–°æµ‹è¯•ä¸€ä¸‹ä»£ç ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">    resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">promise1.then(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled:&#x27;</span>, result);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;rejected:&#x27;</span>, reason)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºé¡ºåºä¸º:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">fulfilled: è¿™æ¬¡ä¸€å®š</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/84273bdd504e7f7e571f93f4f4e34da04d0fdc69f57e33c928da88b0c1b197af/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f30346565383064303830346134613662613638643434366431326663306133372e706e67"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://camo.githubusercontent.com/84273bdd504e7f7e571f93f4f4e34da04d0fdc69f57e33c928da88b0c1b197af/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f30346565383064303830346134613662613638643434366431326663306133372e706e67"
                      alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
                ></a></p>
<p>è¿™æ¬¡çš„é¡ºåºå°±æ¯”è¾ƒé¡ºçœ¼äº†~ğŸ‘ğŸ‘ğŸ‘</p>
<p><strong>åœ¨è¿™é‡Œæˆ‘ä»¬è§£å†³å¼‚æ­¥çš„æ–¹æ³•æ˜¯ç»™<code>resolve</code>å’Œ<code>reject</code>æ·»åŠ <code>setTimeout</code>ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿ</strong></p>
<p>â—¾ è¿™å°±è¦è®²åˆ° <a target="_blank" rel="noopener" href="https://promisesaplus.com/#notes"><strong><code>Promises/A+</code> è§„èŒƒ</strong></a> äº†</p>
<p>è§„èŒƒ <code>2.2.4</code> ï¼š</p>
<blockquote>
<p><code>onFulfilled</code> or <code>onRejected</code> must not be called until the <code>execution context</code> stack contains only platform code. [3.1].</p>
<p>2.2.4 <code>onFulfilled</code> å’Œ <code>onRejected</code> åªæœ‰åœ¨<code>æ‰§è¡Œç¯å¢ƒ</code>å †æ ˆä»…åŒ…å«å¹³å°ä»£ç æ—¶æ‰å¯è¢«è°ƒç”¨ <code>æ³¨1</code></p>
</blockquote>
<p>è§„èŒƒå¯¹2.2.4åšäº†æ³¨é‡Šï¼š</p>
<blockquote>
<p>3.1 Here â€œplatform codeâ€ means engine, environment, and promise implementation code. In practice, this requirement ensures that <code>onFulfilled</code> and <code>onRejected</code> execute asynchronously, after the event loop turn in which <code>then</code> is called, and with a fresh stack. This can be implemented with either a â€œmacro-taskâ€ mechanism such as setTimeout or <code>setImmediate</code>, or with a â€œmicro-taskâ€ mechanism such as MutationObserver or process.nextTick. Since the promise implementation is considered platform code, it may itself contain a task-scheduling queue or â€œtrampolineâ€ in which the handlers are called.</p>
<p><strong>3.1 è¿™é‡Œçš„å¹³å°ä»£ç æŒ‡çš„æ˜¯å¼•æ“ã€ç¯å¢ƒä»¥åŠ promise çš„å®æ–½ä»£ç ã€‚å®è·µä¸­è¦ç¡®ä¿ <code>onFulfilled</code> å’Œ <code>onRejected</code> æ–¹æ³•å¼‚æ­¥æ‰§è¡Œï¼Œä¸”åº”è¯¥åœ¨ <code>then</code> æ–¹æ³•è¢«è°ƒç”¨çš„é‚£ä¸€è½®äº‹ä»¶å¾ªç¯ä¹‹åçš„æ–°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œã€‚è¿™ä¸ªäº‹ä»¶é˜Ÿåˆ—å¯ä»¥é‡‡ç”¨â€œå®ä»»åŠ¡ï¼ˆmacro-taskï¼‰â€æœºåˆ¶ï¼Œæ¯”å¦‚<code>setTimeout</code> æˆ–è€… <code>setImmediate</code>ï¼› ä¹Ÿå¯ä»¥é‡‡ç”¨â€œå¾®ä»»åŠ¡ï¼ˆmicro-taskï¼‰â€æœºåˆ¶æ¥å®ç°ï¼Œ æ¯”å¦‚ <code>MutationObserver</code> æˆ–è€…<code>process.nextTick</code>ã€‚</strong> ç”±äº promise çš„å®æ–½ä»£ç æœ¬èº«å°±æ˜¯å¹³å°ä»£ç ï¼ˆè¯‘è€…æ³¨ï¼š å³éƒ½æ˜¯ JavaScriptï¼‰ï¼Œæ•…ä»£ç è‡ªèº«åœ¨å¤„ç†åœ¨å¤„ç†ç¨‹åºæ—¶å¯èƒ½å·²ç»åŒ…å«ä¸€ä¸ªä»»åŠ¡è°ƒåº¦é˜Ÿåˆ—æˆ–ã€è·³æ¿ã€)ã€‚</p>
</blockquote>
<p>**è¿™é‡Œæˆ‘ä»¬ç”¨çš„å°±æ˜¯è§„èŒƒé‡Œè®²åˆ°çš„ â€œå®ä»»åŠ¡â€ <code>setTimeout</code>**ã€‚</p>
<h2 id="2-å›è°ƒä¿å­˜"><a href="#2-å›è°ƒä¿å­˜" class="headerlink" title="2. å›è°ƒä¿å­˜"></a>2. å›è°ƒä¿å­˜</h2><p>å¼‚æ­¥çš„é—®é¢˜çœŸçš„è§£å†³äº†å—ï¼Ÿç°åœ¨åˆè¦è¿›å…¥Promiseå¦ä¸€ä¸ªéš¾ç‚¹äº†ï¼Œå¤§å®¶åŠ¡å¿…ç«–èµ·è€³æœµå•¦ğŸ˜›</p>
<p>æˆ‘ä»¬æ¥ç»™åŸç”Ÿçš„Promiseé‡Œæ·»åŠ <code>setTimeout</code>ï¼Œä½¿å¾—<code>resolve</code>ä¹Ÿå¼‚æ­¥æ‰§è¡Œï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜äº†ï¼Œ<code>resolve</code>æ˜¯å¼‚æ­¥çš„ï¼Œ<code>then</code>ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œç©¶ç«Ÿè°ä¼šå…ˆè¢«è°ƒç”¨å‘¢ï¼Ÿ</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">+   <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">+       <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">+   &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">promise.then(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled:&#x27;</span>, result);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;rejected:&#x27;</span>, reason)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºé¡ºåºä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">fulfilled: è¿™æ¬¡ä¸€å®š</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ¶‰åŠåˆ°äº†æµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯ï¼Œ<code>promise.then()</code> å’Œ <code>setTimeout()</code> éƒ½æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼Œä½†å®é™…ä¸Šå¼‚æ­¥ä»»åŠ¡ä¹‹é—´å¹¶ä¸ç›¸åŒï¼Œå› æ­¤ä»–ä»¬çš„æ‰§è¡Œä¼˜å…ˆçº§ä¹Ÿæœ‰åŒºåˆ«ã€‚ä¸åŒçš„å¼‚æ­¥ä»»åŠ¡è¢«åˆ†ä¸ºä¸¤ç±»ï¼š<code>å¾®ä»»åŠ¡ (micro task)</code> å’Œ <code>å®ä»»åŠ¡ (macro task</code>)ã€‚</p>
<ul>
<li><code>setTimeout()</code>å±äºå®ä»»åŠ¡</li>
<li><code>promise.then()</code>å±äºå¾®ä»»åŠ¡</li>
</ul>
<p>æˆ‘ä»¬åªéœ€è®°ä½ <strong>å½“å‰æ‰§è¡Œæ ˆæ‰§è¡Œå®Œæ¯•æ—¶ä¼šç«‹åˆ»å…ˆå¤„ç†æ‰€æœ‰å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼Œç„¶åå†å»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªäº‹ä»¶ã€‚åŒä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œå¾®ä»»åŠ¡æ°¸è¿œåœ¨å®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œã€‚</strong></p>
<p><strong>å›åˆ°æ­£æ–‡</strong></p>
<p>æˆ‘ä»¬ç”¨åŒæ ·çš„ä»£ç åº”ç”¨åˆ°æ‰‹å†™çš„éƒ¨åˆ†ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">promise1.then(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled:&#x27;</span>, result);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;rejected:&#x27;</span>, reason)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç° <code>fulfilled: è¿™æ¬¡ä¸€å®š</code> å¹¶æ²¡æœ‰è¾“å‡º</p>
<p>æˆ‘ä»¬å¯ä»¥å…ˆçŒœæµ‹ä¸€ä¸‹ï¼Œæ²¡æœ‰è¾“å‡ºçš„åŸå› å¾ˆå¯èƒ½æ˜¯å› ä¸º<code>then</code>æ–¹æ³•æ²¡æœ‰è¢«æ‰§è¡Œï¼Œçœ‹çœ‹<code>then</code>æ–¹æ³•é‡Œé¢æ˜¯æ ¹æ®æ¡ä»¶åˆ¤æ–­æ¥æ‰§è¡Œä»£ç çš„ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´å¾ˆå¯èƒ½æ²¡æœ‰ç¬¦åˆçš„æ¡ä»¶ï¼Œå†æ¢å¥è¯è¯´å¯èƒ½æ²¡æœ‰ç¬¦åˆçš„çŠ¶æ€</p>
<p>é‚£ä¹ˆæˆ‘ä»¬å°±åœ¨ä¸‰ä¸ªä½ç½®åˆ†åˆ«è¾“å‡ºå½“å‰çš„çŠ¶æ€ï¼Œè¿™æ ·åˆ†åˆ«æ¥åˆ¤æ–­å“ªä¸ªä½ç½®å‡ºäº†é—®é¢˜:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">+       <span class="built_in">console</span>.log(<span class="string">&#x27;A&#x27;</span>,promise1.PromiseState);</span><br><span class="line">        resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">+       <span class="built_in">console</span>.log(<span class="string">&#x27;B&#x27;</span>,promise1.PromiseState);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">promise1.then(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">+       <span class="built_in">console</span>.log(<span class="string">&#x27;C&#x27;</span>,promise1.PromiseState);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled:&#x27;</span>, result);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;rejected:&#x27;</span>, reason)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">A pending</span><br><span class="line">B fulfilled</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<p>å‘ç°åªæœ‰ä¸¤ç»„çŠ¶æ€è¢«è¾“å‡ºï¼Œè¿™ä¸¤ç»„éƒ½åœ¨<code>console.log(4)</code>å‰è¢«è¾“å‡ºï¼Œè¯æ˜<code>setTimeout</code>é‡Œé¢çš„çŠ¶æ€éƒ½è¢«è¾“å‡ºäº†ï¼Œåªæœ‰<code>then</code>é‡Œé¢çš„çŠ¶æ€æ²¡æœ‰è¢«è¾“å‡º</p>
<p>è¿™åŸºæœ¬å°±å¯ä»¥ç¡®å®šæ˜¯å› ä¸º<code>then</code>é‡Œçš„çŠ¶æ€åˆ¤æ–­å‡ºäº†é—®é¢˜</p>
<p>è¿™é‡Œæ¶‰åŠåˆ°äº‹ä»¶å¾ªç¯ï¼Œæˆ‘ä»¬è¯¦ç»†è§£è¯»ä¸€ä¸‹ï¼š</p>
<p>â–ª <strong>é¦–å…ˆ</strong>ï¼Œæ‰§è¡Œ<code>console.log(1)</code>ï¼Œè¾“å‡º<code>1</code></p>
<p>â–ª <strong>ç¬¬äºŒæ­¥</strong>ï¼Œåˆ›å»ºpromiseï¼Œæ‰§è¡Œå‡½æ•°ä½“é‡Œçš„<code>console.log(2)</code>ï¼Œè¾“å‡º<code>2</code></p>
<p>â–ª <strong>ç¬¬ä¸‰æ­¥</strong>ï¼Œé‡åˆ°<code>setTimeout</code>ï¼Œ<code>setTimeout</code>æ˜¯å®ä»»åŠ¡ï¼Œå°†<code>setTimeout</code>åŠ å…¥å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œ</p>
<p>â–ª <strong>ç¬¬å››æ­¥</strong>ï¼Œé‡åˆ°<code>promise.then()</code>ï¼Œ<code>promise.then()</code>æ˜¯å¾®ä»»åŠ¡ï¼Œå°†<code>promise.then()</code>åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œ</p>
<p>â–ª <strong>ç¬¬äº”æ­¥</strong>ï¼Œæ‰§è¡Œ<code>console.log(3)</code>ï¼Œè¾“å‡º<code>3</code>ï¼Œæ­¤æ—¶å½“å‰æ‰§è¡Œæ ˆå·²ç»æ¸…ç©º</p>
<p>â–ª <strong>ç¬¬å…­æ­¥</strong>ï¼Œå½“å‰æ‰§è¡Œæ ˆå·²ç»æ¸…ç©ºï¼Œå…ˆæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ <code>promise.then()</code>ï¼Œå‘ç°promiseçš„çŠ¶æ€å¹¶æ²¡æœ‰æ”¹å˜ï¼Œè¿˜æ˜¯<code>pending</code>ï¼Œæ‰€ä»¥æ²¡æœ‰è¾“å‡ºã€‚çŠ¶æ€å¹¶æ²¡æœ‰æ”¹å˜çš„åŸå› æ˜¯ï¼š<code>resolve(&#39;è¿™æ¬¡ä¸€å®š&#39;)</code>æ˜¯åœ¨<code>setTimeout</code>é‡Œçš„ï¼Œä½†æ­¤æ—¶è¿˜æ²¡å¼€å§‹æ‰§è¡Œ<code>setTimeout</code>ï¼Œå› ä¸º<code>setTimeout</code>æ˜¯å®ä»»åŠ¡ï¼Œå®ä»»åŠ¡åœ¨å¾®ä»»åŠ¡åé¢æ‰§è¡Œ</p>
<p>â–ª <strong>ç¬¬ä¸ƒæ­¥</strong>ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—å·²ç»æ¸…ç©ºï¼Œå¼€å§‹æ‰§è¡Œå®ä»»åŠ¡ <code>setTimeout</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(() =&gt; &#123;</span><br><span class="line">    console.log(&#x27;A&#x27;,promise1.PromiseState);</span><br><span class="line">    resolve(&#x27;è¿™æ¬¡ä¸€å®š&#x27;);</span><br><span class="line">    console.log(&#x27;B&#x27;,promise1.PromiseState);</span><br><span class="line">    console.log(4);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>â–ª <strong>ç¬¬å…«æ­¥</strong>ï¼Œæ‰§è¡Œ <code>console.log(&#39;A&#39;,promise1.PromiseState)</code>ï¼Œæ­¤æ—¶promiseçŠ¶æ€è¿˜æ²¡å‘ç”Ÿå˜åŒ–ï¼Œè¿˜æ˜¯<code>pending</code>ï¼Œæ‰€ä»¥è¾“å‡º <code>A pending</code></p>
<p>â–ª <strong>ç¬¬ä¹æ­¥</strong>ï¼Œæ‰§è¡Œ <code>resolve(&#39;è¿™æ¬¡ä¸€å®š&#39;);</code>ï¼Œæ”¹å˜promiseçš„çŠ¶æ€ä¸º<code>fulfilled</code></p>
<p>â–ª <strong>ç¬¬åæ­¥</strong>ï¼Œæ‰§è¡Œ <code>console.log(&#39;B&#39;,promise1.PromiseState)</code>ï¼Œè¾“å‡º <code>B fulfilled</code></p>
<p>â–ª <strong>ç¬¬åä¸€æ­¥</strong>ï¼Œæ‰§è¡Œ <code>console.log(4)</code>ï¼Œè¾“å‡º<code>4</code></p>
<blockquote>
<p>è¿™é‡Œæš‚ä¸”è®¤ä¸ºæˆ‘ä»¬å†™çš„promise.then()å’ŒåŸç”Ÿä¸€æ ·ï¼Œæ–¹ä¾¿ç†è§£</p>
</blockquote>
<p>â—¾ åˆ†æå®Œä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬çŸ¥é“äº†ï¼Œå› ä¸ºå…ˆæ‰§è¡Œäº†<code>then</code>æ–¹æ³•ï¼Œä½†å‘ç°è¿™ä¸ªæ—¶å€™çŠ¶æ€ä¾æ—§æ˜¯ <code>pending</code>ï¼Œè€Œæˆ‘ä»¬æ‰‹å†™éƒ¨åˆ†æ²¡æœ‰å®šä¹‰<code>pending</code>å¾…å®šçŠ¶æ€çš„æ—¶å€™åº”è¯¥åšä»€ä¹ˆï¼Œå› æ­¤å°±å°‘äº†<code>fulfilled: è¿™æ¬¡ä¸€å®š</code> è¿™å¥è¯çš„è¾“å‡º</p>
<p>æ‰€ä»¥æˆ‘ä»¬å°± <strong>ç›´æ¥ç»™<code>then</code>æ–¹æ³•é‡Œé¢æ·»åŠ å¾…å®šçŠ¶æ€çš„æƒ…å†µå°±å¯ä»¥äº†</strong>ï¼Œä¹Ÿå°±æ˜¯ç”¨<code>if</code>è¿›è¡Œåˆ¤æ–­:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">class myPromise &#123;</span><br><span class="line">	...</span><br><span class="line">    then(onFulfilled, onRejected) &#123;</span><br><span class="line">        onFulfilled = typeof onFulfilled === &#x27;function&#x27; ? onFulfilled : value =&gt; value;</span><br><span class="line">        onRejected = typeof onRejected === &#x27;function&#x27; ? onRejected : reason =&gt; &#123;</span><br><span class="line">            throw reason;</span><br><span class="line">        &#125;;</span><br><span class="line">+       if (this.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">+ 		</span><br><span class="line">+ 		&#125;</span><br><span class="line">        if (this.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            setTimeout(() =&gt; &#123;</span><br><span class="line">                onFulfilled(this.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (this.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            setTimeout(() =&gt; &#123;</span><br><span class="line">                onRejected(this.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â—¾ ä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œå½“<code>then</code>é‡Œé¢åˆ¤æ–­åˆ° <code>pending</code> å¾…å®šçŠ¶æ€æ—¶æˆ‘ä»¬è¦å¹²ä»€ä¹ˆï¼Ÿ</p>
<p>å› ä¸ºè¿™ä¸ªæ—¶å€™<code>resolve</code>æˆ–è€…<code>reject</code>è¿˜æ²¡è·å–åˆ°ä»»ä½•å€¼ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»è®©<code>then</code>é‡Œçš„å‡½æ•°ç¨åå†æ‰§è¡Œï¼Œç­‰<code>resolve</code>æ‰§è¡Œäº†ä»¥åï¼Œå†æ‰§è¡Œ<code>then</code></p>
<p>ä¸ºäº†ä¿ç•™<code>then</code>é‡Œçš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»º <code>æ•°ç»„</code> æ¥ <strong>ä¿å­˜å‡½æ•°</strong>ã€‚</p>
<p>**ä¸ºä»€ä¹ˆç”¨ <code>æ•°ç»„</code> æ¥ä¿å­˜è¿™äº›å›è°ƒå‘¢ï¼Ÿå› ä¸ºä¸€ä¸ªpromiseå®ä¾‹å¯èƒ½ä¼šå¤šæ¬¡ <code>then</code>ï¼Œä¹Ÿå°±æ˜¯ç»å…¸çš„ <code>é“¾å¼è°ƒç”¨</code>**ï¼Œè€Œä¸”æ•°ç»„æ˜¯å…ˆå…¥å…ˆå‡ºçš„é¡ºåº</p>
<p>åœ¨å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™å°±è®©æ¯ä¸ªå®ä¾‹éƒ½æœ‰è¿™ä¸¤ä¸ªæ•°ç»„ï¼š</p>
<ul>
<li><code>onFulfilledCallbacks</code> ï¼šç”¨æ¥ <strong>ä¿å­˜æˆåŠŸå›è°ƒ</strong></li>
<li><code>onRejectedCallbacks</code> ï¼šç”¨æ¥ <strong>ä¿å­˜å¤±è´¥å›è°ƒ</strong></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">+       <span class="built_in">this</span>.onFulfilledCallbacks = []; <span class="comment">// ä¿å­˜æˆåŠŸå›è°ƒ</span></span><br><span class="line">+       <span class="built_in">this</span>.onRejectedCallbacks = []; <span class="comment">// ä¿å­˜å¤±è´¥å›è°ƒ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="built_in">this</span>.reject(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â—¾ æ¥ç€å°±å®Œå–„<code>then</code>é‡Œé¢çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯å½“åˆ¤æ–­åˆ°çŠ¶æ€ä¸º <code>pending</code> å¾…å®šæ—¶ï¼Œæš‚æ—¶ä¿å­˜ä¸¤ä¸ªå›è°ƒï¼Œä¹Ÿå°±æ˜¯è¯´æš‚ä¸”æŠŠ<code>then</code>é‡Œçš„ä¸¤ä¸ªå‡½æ•°å‚æ•°åˆ†åˆ«æ”¾åœ¨ä¸¤ä¸ªæ•°ç»„é‡Œé¢ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.onFulfilledCallbacks = []; <span class="comment">// ä¿å­˜æˆåŠŸå›è°ƒ</span></span><br><span class="line">        <span class="built_in">this</span>.onRejectedCallbacks = []; <span class="comment">// ä¿å­˜å¤±è´¥å›è°ƒ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="built_in">this</span>.reject(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function">() =&gt;</span> &#123;&#125;;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function">() =&gt;</span> &#123;&#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">+           <span class="built_in">this</span>.onFulfilledCallbacks.push(onFulfilled);</span><br><span class="line">+           <span class="built_in">this</span>.onRejectedCallbacks.push(onRejected);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â—¾ æ•°ç»„é‡Œé¢æ”¾å®Œå‡½æ•°ä»¥åï¼Œå°±å¯ä»¥å®Œå–„<code>resolve</code>å’Œ<code>reject</code>çš„ä»£ç äº†</p>
<p><strong>åœ¨æ‰§è¡Œ<code>resolve</code>æˆ–è€…<code>reject</code>çš„æ—¶å€™ï¼Œéå†è‡ªèº«çš„<code>callbacks</code>æ•°ç»„</strong>ï¼Œçœ‹çœ‹æ•°ç»„é‡Œé¢æœ‰æ²¡æœ‰<code>then</code>é‚£è¾¹ <strong>ä¿ç•™</strong> è¿‡æ¥çš„ <strong>å¾…æ‰§è¡Œå‡½æ•°</strong>ï¼Œ<strong>ç„¶åé€ä¸ªæ‰§è¡Œæ•°ç»„é‡Œé¢çš„å‡½æ•°</strong>ï¼Œæ‰§è¡Œçš„æ—¶å€™ä¼šä¼ å…¥ç›¸åº”çš„å‚æ•°ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.onFulfilledCallbacks = []; <span class="comment">// ä¿å­˜æˆåŠŸå›è°ƒ</span></span><br><span class="line">        <span class="built_in">this</span>.onRejectedCallbacks = []; <span class="comment">// ä¿å­˜å¤±è´¥å›è°ƒ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="built_in">this</span>.reject(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">+           <span class="built_in">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">+               callback(result)</span><br><span class="line">+           &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line"> +          <span class="built_in">this</span>.onRejectedCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line"> +              callback(reason)</span><br><span class="line"> +          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.onFulfilledCallbacks.push(onFulfilled);</span><br><span class="line">            <span class="built_in">this</span>.onRejectedCallbacks.push(onRejected);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®Œå–„å¥½ä»£ç åï¼Œè®©æˆ‘ä»¬å†æ¥æµ‹è¯•ä»¥ä¸‹åˆšæ‰çš„å®ä¾‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;A&#x27;</span>, promise1.PromiseState);</span><br><span class="line">        resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;B&#x27;</span>, promise1.PromiseState);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">promise1.then(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;C&#x27;</span>, promise1.PromiseState);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled:&#x27;</span>, result);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;rejected:&#x27;</span>, reason)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">A pending</span><br><span class="line">C fulfilled</span><br><span class="line">fulfilled: è¿™æ¬¡ä¸€å®š</span><br><span class="line">B fulfilled</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<p><strong>ä»ä¸Šé¢çš„ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>fulfilled: è¿™æ¬¡ä¸€å®š</code> æ‰“å°å‡ºæ¥å•¦ï¼Œ<code>promise1.then()</code>æ–¹æ³•ä¹Ÿæ­£å¸¸æ‰§è¡Œï¼Œæ‰“å°å‡ºäº†å½“å‰çš„çŠ¶æ€ï¼š<code>B fulfilled</code></strong></p>
<p><strong>ä½†æ˜¯</strong>ä»£ç è¾“å‡ºé¡ºåºè¿˜æ˜¯ä¸å¤ªå¯¹ï¼ŒåŸç”ŸPromiseä¸­ï¼Œ<code>fulfilled: è¿™æ¬¡ä¸€å®š</code> æ˜¯æœ€åè¾“å‡ºçš„</p>
<p>â—¾ è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆå¤šäººå¿½ç•¥çš„å°ç»†èŠ‚ï¼Œ**<code>resolve</code> å’Œ <code>reject</code> æ˜¯è¦åœ¨ <code>äº‹ä»¶å¾ªç¯æœ«å°¾</code> æ‰§è¡Œçš„**ï¼Œå› æ­¤æˆ‘ä»¬å°± <strong>ç»™ <code>resolve</code> å’Œ <code>reject</code> é‡Œé¢åŠ ä¸Š <code>setTimeout</code></strong> å°±å¯ä»¥äº†</p>
<p><strong>æˆ‘ä»¬åœ¨åˆ¤æ–­å®Œ <code>promise</code> çŠ¶æ€åå†åŠ  <code>setTimeout</code> ï¼š</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.onFulfilledCallbacks = []; <span class="comment">// ä¿å­˜æˆåŠŸå›è°ƒ</span></span><br><span class="line">        <span class="built_in">this</span>.onRejectedCallbacks = []; <span class="comment">// ä¿å­˜å¤±è´¥å›è°ƒ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="built_in">this</span>.reject(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">+           <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">                <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">                <span class="built_in">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                    callback(result)</span><br><span class="line">                &#125;)</span><br><span class="line">+           &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">+           <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">                <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">                <span class="built_in">this</span>.onRejectedCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                    callback(reason)</span><br><span class="line">                &#125;)</span><br><span class="line">+           &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆä¸åƒä¸‹é¢è¿™æ ·å‘¢ï¼Ÿ</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">	 <span class="comment">// bad</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">            <span class="built_in">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                callback(result)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">	 <span class="comment">// bad</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">            <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">            <span class="built_in">this</span>.onRejectedCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                callback(reason)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºåœ¨ä¸€ä¸ªpromiseé‡Œï¼Œå¯èƒ½æœ‰çš„äººä¼šä¸æ³¨æ„åŒæ—¶ç”¨äº†<code>resolve()</code> å’Œ <code>reject()</code> ï¼Œåƒè¿™æ ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let promise = new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">    resolve(&#x27;è¿™æ¬¡ä¸€å®š&#x27;)</span><br><span class="line">    reject(&#x27;ä¸‹æ¬¡ä¸€å®š&#x27;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>â–ª å¦‚æœæŠŠ <code>setTimeout</code> æ”¾åˆ° <code>if</code> åˆ¤æ–­ä¹‹å‰ï¼Œé‚£å²‚ä¸æ˜¯å°±ç®—çŠ¶æ€ä¸æ»¡è¶³æ¡ä»¶ï¼Œæˆ‘ä»¬ä¹Ÿè¦å¼€å¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œä¸Šé¢çš„æƒ…å†µï¼ŒåŒæ—¶ç”¨äº†<code>resolve()</code> å’Œ <code>reject()</code>ï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯è¦åŒæ—¶å¼€å¯ä¸¤ä¸ªå®šæ—¶å™¨ï¼Ÿå¦‚æœåœ¨ä¸€ä¸ªpromiseé‡Œå¤šæ¬¡ä½¿ç”¨ <code>resolve()</code> å’Œ <code>reject()</code> æ–¹æ³•ï¼Œé‚£å²‚ä¸æ˜¯è¦å¼€å¯æ›´å¤šçš„æ— ç”¨çš„å®šæ—¶å™¨ï¼Ÿ</p>
<p>â–ª å¦‚æœå…ˆåˆ¤æ–­çŠ¶æ€å†æ·»åŠ å®šæ—¶å™¨ï¼Œè¿™æ ·æˆ‘ä»¬å°± <strong>åªä¼šæ»¡è¶³æ¡ä»¶åæ‰å¼€å¯ä¸€ä¸ªå®šæ—¶å™¨</strong>ï¼Œç›¸æ¯”ä¸Šé¢çš„æƒ…å†µï¼Œè¿™æ ·çš„ <strong>å¼€é”€</strong> å°±å°äº†å¾ˆå¤š</p>
<p>èŠå®Œç»†èŠ‚ï¼Œæˆ‘ä»¬å›åˆ°æ­£æ–‡ï¼Œæ£€éªŒä¸€ä¸‹è¿™æ¬¡æ˜¯å¦èƒ½è¡Œï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.onFulfilledCallbacks = []; <span class="comment">// ä¿å­˜æˆåŠŸå›è°ƒ</span></span><br><span class="line">        <span class="built_in">this</span>.onRejectedCallbacks = []; <span class="comment">// ä¿å­˜å¤±è´¥å›è°ƒ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="built_in">this</span>.reject(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">                <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">                <span class="built_in">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                    callback(result)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">                <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">                <span class="built_in">this</span>.onRejectedCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                    callback(reason)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.onFulfilledCallbacks.push(onFulfilled);</span><br><span class="line">            <span class="built_in">this</span>.onRejectedCallbacks.push(onRejected);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;A&#x27;</span>, promise1.PromiseState);</span><br><span class="line">        resolve(<span class="string">&#x27;è¿™æ¬¡ä¸€å®š&#x27;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;B&#x27;</span>, promise1.PromiseState);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">promise1.then(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;C&#x27;</span>, promise1.PromiseState);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled:&#x27;</span>, result);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;rejected:&#x27;</span>, reason)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºé¡ºåºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">A pending</span><br><span class="line">B pending</span><br><span class="line">4</span><br><span class="line">C fulfilled</span><br><span class="line">fulfilled: è¿™æ¬¡ä¸€å®š</span><br></pre></td></tr></table></figure>

<p><strong>å¯ä»¥çœ‹åˆ°æœ€åè¾“å‡º <code>fulfilled: è¿™æ¬¡ä¸€å®š</code> ï¼Œå’ŒåŸç”ŸPromiseé¡ºåºä¸€è‡´ï¼</strong></p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»å®Œæˆäº† <strong>promiseçš„å›è°ƒä¿å­˜</strong>ï¼Œå·²ç»è¶Šæ¥è¶Šæ¥è¿‘èƒœåˆ©äº†ğŸ˜º</p>
<h2 id="3-éªŒè¯-then-æ–¹æ³•å¤šæ¬¡è°ƒç”¨"><a href="#3-éªŒè¯-then-æ–¹æ³•å¤šæ¬¡è°ƒç”¨" class="headerlink" title="3. éªŒè¯ then æ–¹æ³•å¤šæ¬¡è°ƒç”¨"></a>3. éªŒè¯ then æ–¹æ³•å¤šæ¬¡è°ƒç”¨</h2><p>Promise çš„ then æ–¹æ³•å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ã€‚</p>
<p>ç”¨ä¸€ä¸ª ğŸŒ° ï¼Œæ¥éªŒè¯ä¸€ä¸‹æˆ‘ä»¬å†™çš„promise <code>then</code> æ–¹æ³•æ˜¯å¦å¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.onFulfilledCallbacks = []; <span class="comment">// ä¿å­˜æˆåŠŸå›è°ƒ</span></span><br><span class="line">        <span class="built_in">this</span>.onRejectedCallbacks = []; <span class="comment">// ä¿å­˜å¤±è´¥å›è°ƒ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="built_in">this</span>.reject(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">                <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">                <span class="built_in">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                    callback(result)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">                <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">                <span class="built_in">this</span>.onRejectedCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                    callback(reason)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.onFulfilledCallbacks.push(onFulfilled);</span><br><span class="line">            <span class="built_in">this</span>.onRejectedCallbacks.push(onRejected);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        resolve(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;)</span><br><span class="line">promise.then(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;resolve&#x27;</span>, value)</span><br><span class="line">&#125;)</span><br><span class="line">promise.then(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;resolve&#x27;</span>, value)</span><br><span class="line">&#125;)</span><br><span class="line">promise.then(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;resolve&#x27;</span>, value)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä¸Šé¢ ğŸŒ°ï¼Œè¾“å‡ºç»“æœğŸ‘‡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">resolve success</span><br><span class="line">2</span><br><span class="line">resolve success</span><br><span class="line">3</span><br><span class="line">resolve success</span><br></pre></td></tr></table></figure>

<p>æ‰€æœ‰ <code>then</code> ä¸­çš„å›è°ƒå‡½æ•°éƒ½å·²ç»æ‰§è¡Œ ğŸ˜</p>
<p>è¯´æ˜æˆ‘ä»¬å½“å‰çš„ä»£ç ï¼Œå·²ç»å¯ä»¥å®ç° <code>then</code> æ–¹æ³•çš„å¤šæ¬¡è°ƒç”¨âœ¨</p>
<p>ğŸ‘ğŸ‘ğŸ‘ å®Œç¾ï¼Œç»§ç»­</p>
<h1 id="äº”ã€å®ç°-then-æ–¹æ³•çš„é“¾å¼è°ƒç”¨"><a href="#äº”ã€å®ç°-then-æ–¹æ³•çš„é“¾å¼è°ƒç”¨" class="headerlink" title="äº”ã€å®ç° then æ–¹æ³•çš„é“¾å¼è°ƒç”¨"></a>äº”ã€å®ç° then æ–¹æ³•çš„é“¾å¼è°ƒç”¨</h1><p><strong>æˆ‘ä»¬å¸¸å¸¸ç”¨åˆ° <code>new Promise().then().then()</code>ï¼Œè¿™å°±æ˜¯é“¾å¼è°ƒç”¨ï¼Œç”¨æ¥è§£å†³å›è°ƒåœ°ç‹±</strong></p>
<p>ä¸¾ä¸ªä¾‹å­ ğŸŒ°</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="number">10</span>)</span><br><span class="line">&#125;)</span><br><span class="line">p1.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled&#x27;</span>, res);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> * res</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled&#x27;</span>, res)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºğŸ‘‡ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fulfilled 100</span><br><span class="line">fulfilled 200</span><br></pre></td></tr></table></figure>

<p>å†ä¸¾ä¸€ä¸ªä¾‹å­ ğŸŒ° ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="number">100</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">p2.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled&#x27;</span>, res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> resolve(<span class="number">3</span> * res))</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled&#x27;</span>, res)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºğŸ‘‡ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fulfilled 100</span><br><span class="line">fulfilled 300</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…ˆè¯•ä¸€ä¸‹å½“å‰çš„<code>myPromise</code>æ˜¯å¦å¯ä»¥å®ç°é“¾å¼è°ƒç”¨ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.onFulfilledCallbacks = []; <span class="comment">// ä¿å­˜æˆåŠŸå›è°ƒ</span></span><br><span class="line">        <span class="built_in">this</span>.onRejectedCallbacks = []; <span class="comment">// ä¿å­˜å¤±è´¥å›è°ƒ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="built_in">this</span>.reject(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">                <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">                <span class="built_in">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                    callback(result)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">                <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">                <span class="built_in">this</span>.onRejectedCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                    callback(reason)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">this</span>.onFulfilledCallbacks.push(onFulfilled);</span><br><span class="line">            <span class="built_in">this</span>.onRejectedCallbacks.push(onRejected);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="keyword">let</span> p1 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="number">10</span>)</span><br><span class="line">&#125;)</span><br><span class="line">p1.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled&#x27;</span>, res);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> * res</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;fulfilled&#x27;</span>, res)</span><br><span class="line">&#125;) </span><br></pre></td></tr></table></figure>

<p>æ¯«æ— ç–‘é—®åœ¨æ§åˆ¶å°é‡Œé¢æ˜¯ä¼šæŠ¥é”™çš„ï¼Œæç¤º <code>then</code> æ–¹æ³•æ²¡æœ‰å®šä¹‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Uncaught TypeError: Cannot read property &#x27;then&#x27; of undefined</span><br></pre></td></tr></table></figure>

<p><strong><code>Promise.prototype.then()</code> æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promiseå®ä¾‹ï¼ˆæ³¨æ„ï¼Œä¸æ˜¯åŸæ¥é‚£ä¸ª<code>Promise</code>å®ä¾‹ï¼‰ã€‚å› æ­¤å¯ä»¥é‡‡ç”¨é“¾å¼å†™æ³•ï¼Œå³thenæ–¹æ³•åé¢å†è°ƒç”¨å¦ä¸€ä¸ªthenæ–¹æ³•ã€‚</strong></p>
<h2 id="1-Promises-A-è§„èŒƒçš„ç†è§£"><a href="#1-Promises-A-è§„èŒƒçš„ç†è§£" class="headerlink" title="1. Promises/A+ è§„èŒƒçš„ç†è§£"></a>1. Promises/A+ è§„èŒƒçš„ç†è§£</h2><p>â—¾ <strong>æƒ³è¦å®ç°<code>then</code>æ–¹æ³•çš„é“¾å¼è°ƒç”¨ï¼Œå°±å¿…é¡»å½»åº•ææ‡‚<code>then</code>æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å‚è€ƒ <a target="_blank" rel="noopener" href="https://promisesaplus.com/#notes">*<em><code>Promises/A+</code> è§„èŒƒ*</em></a> ğŸ‘‡</strong></p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/958775fa09e2ac56c8a5d8a9d52914173522ff234a3cbef3a398f4a781201014/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f64343331343835656136313034333765393937633666646135633661633464662e706e67"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://camo.githubusercontent.com/958775fa09e2ac56c8a5d8a9d52914173522ff234a3cbef3a398f4a781201014/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f64343331343835656136313034333765393937633666646135633661633464662e706e67"
                      alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
                ></a></p>
<p><strong>è§„èŒƒåœ¨<code>2.2.7</code>ä¸­è¿™æ ·æè¿° ğŸ‘‡ï¼š</strong></p>
<p>â—¾ <strong>2.2.7 then æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª promise å¯¹è±¡</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">promise2 = promise1.then(onFulfilled, onRejected);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>2.2.7.1</strong> å¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> è¿”å›ä¸€ä¸ªå€¼ <code>x</code> ï¼Œåˆ™è¿è¡Œä¸‹é¢çš„ <strong>Promise è§£å†³è¿‡ç¨‹ï¼š<code>[[Resolve]](promise2, x)</code></strong></li>
<li><strong>2.2.7.2</strong> å¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ <code>e</code> ï¼Œåˆ™ <code>promise2</code> å¿…é¡»æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›æ‹’å›  <code>e</code></li>
<li><strong>2.2.7.3</strong> å¦‚æœ <code>onFulfilled</code> ä¸æ˜¯å‡½æ•°ä¸” <code>promise1</code> æˆåŠŸæ‰§è¡Œï¼Œ <code>promise2</code> å¿…é¡»æˆåŠŸæ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„å€¼</li>
<li><strong>2.2.7.4</strong> å¦‚æœ <code>onRejected</code> ä¸æ˜¯å‡½æ•°ä¸” <code>promise1</code> æ‹’ç»æ‰§è¡Œï¼Œ <code>promise2</code> å¿…é¡»æ‹’ç»æ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„æ®å› </li>
</ul>
<p>ç†è§£ä¸Šé¢çš„<code>â€œè¿”å›â€</code>éƒ¨åˆ†éå¸¸é‡è¦ï¼Œå³ï¼š<strong>ä¸è®º promise1 è¢« reject è¿˜æ˜¯è¢« resolve æ—¶ promise2 éƒ½ä¼šæ‰§è¡Œ Promise è§£å†³è¿‡ç¨‹ï¼š<code>[[Resolve]](promise2, x)</code>ï¼Œåªæœ‰å‡ºç°å¼‚å¸¸æ—¶æ‰ä¼šè¢« rejectedã€‚</strong></p>
<p>æ³¨æ„ <strong>2.2.7.1</strong> ï¼š</p>
<blockquote>
<p>If either onFulfilled or onRejected returns a value x, <strong><code>run the Promise Resolution Procedure [[Resolve]](promise2, x).</code></strong></p>
<p>å³ï¼šå¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> è¿”å›ä¸€ä¸ªå€¼ <code>x</code> ï¼Œåˆ™è¿è¡Œä¸‹é¢çš„ <strong>Promise è§£å†³è¿‡ç¨‹ï¼š<code>[[Resolve]](promise2, x)</code></strong></p>
</blockquote>
<p>è§„èŒƒåœ¨ <strong>2.3</strong> ä¸­è¯¦ç»†æè¿° <strong>Promise è§£å†³è¿‡ç¨‹</strong> <code>The Promise Resolution Procedure</code> ğŸ‘‡</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/0b8d65a23570678e11739d565f0fb7acb4d5120c11cf8c9227f63126939382ab/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f34386234363938623539653434323736623438373236643134313064356265652e706e67"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://camo.githubusercontent.com/0b8d65a23570678e11739d565f0fb7acb4d5120c11cf8c9227f63126939382ab/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f34386234363938623539653434323736623438373236643134313064356265652e706e67"
                      alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
                ></a></p>
<p>è¯‘è¿‡æ¥ ğŸ‘‡ï¼š</p>
<p>â—¾ <strong>2.3 Promise è§£å†³è¿‡ç¨‹</strong></p>
<p><strong>Promise è§£å†³è¿‡ç¨‹</strong> æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ“ä½œï¼Œå…¶éœ€è¾“å…¥ä¸€ä¸ª <code>promise</code> å’Œä¸€ä¸ªå€¼ï¼Œæˆ‘ä»¬è¡¨ç¤ºä¸º <code>[[Resolve]](promise, x)</code>ï¼Œå¦‚æœ <code>x</code> æœ‰ <code>then</code> æ–¹æ³•ä¸”çœ‹ä¸Šå»åƒä¸€ä¸ª <code>Promise</code> ï¼Œè§£å†³ç¨‹åºå³å°è¯•ä½¿ <code>promise</code> æ¥å— <code>x</code> çš„çŠ¶æ€ï¼›å¦åˆ™å…¶ç”¨ <code>x</code> çš„å€¼æ¥æ‰§è¡Œ <code>promise</code> ã€‚</p>
<p>è¿™ç§ <code>thenable</code> çš„ç‰¹æ€§ä½¿å¾— <code>Promise</code> çš„å®ç°æ›´å…·æœ‰é€šç”¨æ€§ï¼š<strong>åªè¦å…¶æš´éœ²å‡ºä¸€ä¸ªéµå¾ª <code>Promises/A+</code> åè®®çš„ <code>then</code> æ–¹æ³•å³å¯ï¼›è¿™åŒæ—¶ä¹Ÿä½¿éµå¾ª <code>Promises/A+</code> è§„èŒƒçš„å®ç°å¯ä»¥ä¸é‚£äº›ä¸å¤ªè§„èŒƒä½†å¯ç”¨çš„å®ç°èƒ½è‰¯å¥½å…±å­˜ã€‚</strong></p>
<p><strong>è¿è¡Œ <code>[[Resolve]](promise, x)</code> éœ€éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š</strong></p>
<p>â–ª <strong>2.3.1 <code>x</code> ä¸ promise ç›¸ç­‰</strong></p>
<p>å¦‚æœ <code>promise</code> å’Œ <code>x</code> æŒ‡å‘åŒä¸€å¯¹è±¡ï¼Œä»¥ <code>TypeError</code> ä¸ºæ®å› æ‹’ç»æ‰§è¡Œ <code>promise</code></p>
<p>â–ª <strong>2.3.2 <code>x</code> ä¸º Promise</strong></p>
<p>å¦‚æœ <code>x</code> ä¸º Promise ï¼Œåˆ™ä½¿ <code>promise</code> æ¥å— <code>x</code> çš„çŠ¶æ€</p>
<ul>
<li>2.3.2.1 å¦‚æœ <code>x</code> å¤„äºç­‰å¾…æ€ï¼Œ <code>promise</code> éœ€ä¿æŒä¸ºç­‰å¾…æ€ç›´è‡³ <code>x</code> è¢«æ‰§è¡Œæˆ–æ‹’ç»</li>
<li>2.3.2.2 å¦‚æœ <code>x</code> å¤„äºæ‰§è¡Œæ€ï¼Œç”¨ç›¸åŒçš„å€¼æ‰§è¡Œ <code>promise</code></li>
<li>2.3.2.3 å¦‚æœ <code>x</code> å¤„äºæ‹’ç»æ€ï¼Œç”¨ç›¸åŒçš„æ®å› æ‹’ç» <code>promise</code></li>
</ul>
<p>â–ª <strong>2.3.3 <code>x</code> ä¸ºå¯¹è±¡æˆ–å‡½æ•°</strong></p>
<p>å¦‚æœ x ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼š</p>
<ul>
<li>2.3.3.1 æŠŠ <code>x.then</code> èµ‹å€¼ç»™ <code>then</code></li>
<li>2.3.3.2 å¦‚æœå– <code>x.then</code> çš„å€¼æ—¶æŠ›å‡ºé”™è¯¯ <code>e</code> ï¼Œåˆ™ä»¥ <code>e</code> ä¸ºæ®å› æ‹’ç» <code>promise</code></li>
<li>2.3.3.3 å¦‚æœ <code>then</code> æ˜¯å‡½æ•°ï¼Œå°† <code>x</code> ä½œä¸ºå‡½æ•°çš„ä½œç”¨åŸŸ <code>this</code> è°ƒç”¨ä¹‹ã€‚ä¼ é€’ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å«åš <code>resolvePromise</code> ï¼Œç¬¬äºŒä¸ªå‚æ•°å«åš <code>rejectPromise</code>:<ul>
<li>2.3.3.3.1 å¦‚æœ <code>resolvePromise</code> ä»¥å€¼ <code>y</code> ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™è¿è¡Œ <code>[[Resolve]](promise, y)</code></li>
<li>2.3.3.3.2 å¦‚æœ <code>rejectPromise</code> ä»¥æ®å›  <code>r</code> ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™ä»¥æ®å›  <code>r</code> æ‹’ç» <code>promise</code></li>
<li>2.3.3.3.3 å¦‚æœ <code>resolvePromise</code> å’Œ <code>rejectPromise</code> å‡è¢«è°ƒç”¨ï¼Œæˆ–è€…è¢«åŒä¸€å‚æ•°è°ƒç”¨äº†å¤šæ¬¡ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨é¦–æ¬¡è°ƒç”¨å¹¶å¿½ç•¥å‰©ä¸‹çš„è°ƒç”¨</li>
<li>2.3.3.3.4 å¦‚æœè°ƒç”¨ <code>then</code> æ–¹æ³•æŠ›å‡ºäº†å¼‚å¸¸ <code>e</code>ï¼š<ul>
<li>2.3.3.3.4.1 å¦‚æœ <code>resolvePromise</code> æˆ– <code>rejectPromise</code> å·²ç»è¢«è°ƒç”¨ï¼Œåˆ™å¿½ç•¥ä¹‹</li>
<li>2.3.3.3.4.2 å¦åˆ™ä»¥ <code>e</code> ä¸ºæ®å› æ‹’ç» <code>promise</code></li>
</ul>
</li>
<li>2.3.3.4 å¦‚æœ <code>then</code> ä¸æ˜¯å‡½æ•°ï¼Œä»¥ <code>x</code> ä¸ºå‚æ•°æ‰§è¡Œ <code>promise</code></li>
</ul>
</li>
</ul>
<p><strong>â–ª 2.3.4 å¦‚æœ <code>x</code> ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ <code>x</code> ä¸ºå‚æ•°æ‰§è¡Œ <code>promise</code></strong></p>
<p>å¦‚æœä¸€ä¸ª <code>promise</code> è¢«ä¸€ä¸ªå¾ªç¯çš„ <code>thenable</code> é“¾ä¸­çš„å¯¹è±¡è§£å†³ï¼Œè€Œ <code>[[Resolve]](promise, thenable)</code> çš„é€’å½’æ€§è´¨åˆä½¿å¾—å…¶è¢«å†æ¬¡è°ƒç”¨ï¼Œæ ¹æ®ä¸Šè¿°çš„ç®—æ³•å°†ä¼šé™·å…¥æ— é™é€’å½’ä¹‹ä¸­ã€‚ç®—æ³•è™½ä¸å¼ºåˆ¶è¦æ±‚ï¼Œä½†ä¹Ÿé¼“åŠ±æ–½è€…æ£€æµ‹è¿™æ ·çš„é€’å½’æ˜¯å¦å­˜åœ¨ï¼Œè‹¥æ£€æµ‹åˆ°å­˜åœ¨åˆ™ä»¥ä¸€ä¸ªå¯è¯†åˆ«çš„ <code>TypeError</code> ä¸ºæ®å› æ¥æ‹’ç» <code>promise</code>ã€‚</p>
<h2 id="2-Promises-A-è§„èŒƒçš„æ€»ç»“"><a href="#2-Promises-A-è§„èŒƒçš„æ€»ç»“" class="headerlink" title="2. Promises/A+ è§„èŒƒçš„æ€»ç»“"></a>2. Promises/A+ è§„èŒƒçš„æ€»ç»“</h2><p>åŸºäºè§„èŒƒçš„æè¿°ï¼Œæˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<p><strong>â—¾ 1.</strong> <code>then</code>æ–¹æ³•æœ¬èº«ä¼šè¿”å›ä¸€ä¸ªæ–°çš„<code>Promise</code>å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„Promiseä»¥åå®ƒå°±æœ‰è‡ªå·±çš„<code>then</code>æ–¹æ³•ï¼Œè¿™æ ·å°±èƒ½å®ç°æ— é™çš„é“¾å¼</p>
<p><strong>â—¾ 2.</strong> ä¸è®º <code>promise1</code> è¢« <code>resolve()</code> è¿˜æ˜¯è¢« <code>reject()</code> æ—¶ <code>promise2</code> éƒ½ä¼šæ‰§è¡Œ <strong><code>Promise è§£å†³è¿‡ç¨‹ï¼š[[Resolve]](promise2, x)</code></strong></p>
<p>åœ¨æ‰‹å†™è¿™é‡Œæˆ‘ä»¬æŠŠè¿™ä¸ª <strong><code>Promise è§£å†³è¿‡ç¨‹ï¼š[[Resolve]](promise2, x)</code></strong> å‘½åä¸º <code>resolvePromise()</code> æ–¹æ³•ï¼Œå‚æ•°ä¸º <code>(promise2, x, resolve, reject)</code> å³ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function resolvePromise(promise2, x, resolve, reject) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>resolvePromise()</code>å„å‚æ•°çš„æ„ä¹‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†</span><br><span class="line"> * @param  &#123;promise&#125; promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡</span><br><span class="line"> * @param  &#123;[type]&#125; x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼</span><br><span class="line"> * @param  &#123;[type]&#125; resolve   promise2çš„resolveæ–¹æ³•</span><br><span class="line"> * @param  &#123;[type]&#125; reject    promise2çš„rejectæ–¹æ³•</span><br><span class="line"> */</span><br><span class="line">function resolvePromise(promise2, x, resolve, reject) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å®ï¼Œè¿™ä¸ª<code>resolvePromise(promise2, x, resolve, reject)</code> å³ <code>Promise è§£å†³è¿‡ç¨‹ï¼š[[Resolve]](promise2, x)</code> å°±æ˜¯å¯¹<code>resolve()ã€reject()</code> è¿›è¡Œ<strong>æ”¹é€ å¢å¼º</strong>ï¼Œ é’ˆå¯¹<code>resolve()</code>å’Œ<code>reject()</code>ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†ã€‚</p>
<p><code>resolve()</code>å’Œ<code>reject()</code> è¿”å›çš„ <code>x</code> å€¼çš„å‡ ç§æƒ…å†µï¼š</p>
<ol>
<li>æ™®é€šå€¼</li>
<li>Promiseå¯¹è±¡</li>
<li>thenableå¯¹è±¡/å‡½æ•°</li>
</ol>
<p><strong>ä¸‹é¢æˆ‘ä»¬å°±æ ¹æ®æ€»ç»“çš„ä¸¤ç‚¹ï¼Œç»“åˆ <code>Promises/A+ è§„èŒƒ</code> æ¥å®ç° <code>then</code> æ–¹æ³•çš„é“¾å¼è°ƒç”¨ ğŸ’ªğŸ’ªğŸ’ª</strong></p>
<h2 id="3-then-æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promise"><a href="#3-then-æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promise" class="headerlink" title="3. then æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promise"></a>3. then æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promise</h2><p>â—¾ <strong>2.2.7è§„èŒƒ then æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª promise å¯¹è±¡</strong></p>
<p>æˆ‘ä»¬åœ¨<code>then</code>æ–¹æ³•é‡Œé¢è¿”å›ä¸€ä¸ª <code>æ–°çš„æ‰‹å†™Promiseå®ä¾‹</code>ï¼Œå†æŠŠåŸæ¥çš„ä»£ç å¤åˆ¶ä¸Šå»ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">class myPromise &#123;</span><br><span class="line">	...</span><br><span class="line">    then(onFulfilled, onRejected) &#123;</span><br><span class="line">        onFulfilled = typeof onFulfilled === &#x27;function&#x27; ? onFulfilled : value =&gt; value;</span><br><span class="line">        onRejected = typeof onRejected === &#x27;function&#x27; ? onRejected : reason =&gt; &#123;</span><br><span class="line">            throw reason;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">+       const promise2 = new myPromise((resolve, reject) =&gt; &#123;</span><br><span class="line">            if (this.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">                setTimeout(() =&gt; &#123;</span><br><span class="line">                    onFulfilled(this.PromiseResult);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; else if (this.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">                setTimeout(() =&gt; &#123;</span><br><span class="line">                    onRejected(this.PromiseResult);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; else if (this.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">                this.onFulfilledCallbacks.push(onFulfilled);</span><br><span class="line">                this.onRejectedCallbacks.push(onRejected);</span><br><span class="line">            &#125;</span><br><span class="line">+       &#125;)</span><br><span class="line">        </span><br><span class="line">+       return promise2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>â—¾ 2.2.7.1è§„èŒƒ</strong> å¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> è¿”å›ä¸€ä¸ªå€¼ <code>x</code> ï¼Œåˆ™è¿è¡Œä¸‹é¢çš„ <strong>Promise è§£å†³è¿‡ç¨‹ï¼š<code>[[Resolve]](promise2, x)</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : +<span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> promise2 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">+                   <span class="keyword">let</span> x = onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">+                   resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">+                   <span class="keyword">let</span> x = onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">+                   resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">                <span class="built_in">this</span>.onFulfilledCallbacks.push(onFulfilled);</span><br><span class="line">                <span class="built_in">this</span>.onRejectedCallbacks.push(onRejected);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+<span class="comment">/**</span></span><br><span class="line"><span class="comment">+ * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="comment">+ * <span class="doctag">@param  <span class="type">&#123;promise&#125;</span> </span>promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡</span></span><br><span class="line"><span class="comment">+ * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼</span></span><br><span class="line"><span class="comment">+ * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>resolve   promise2çš„resolveæ–¹æ³•</span></span><br><span class="line"><span class="comment">+ * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>reject    promise2çš„rejectæ–¹æ³•</span></span><br><span class="line"><span class="comment">+ */</span></span><br><span class="line">+ <span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2, x, resolve, reject</span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨ <code>myPromise</code> ç±»å¤–é¢å£°æ˜äº†ä¸€ä¸ª <strong>Promise è§£å†³è¿‡ç¨‹</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function resolvePromise(promise2, x, resolve, reject) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>resolvePromise()</code> å…·ä½“æ–¹æ³•æˆ‘ä»¬åé¢ä¼šè¡¥å……~</strong></p>
<p><strong>â—¾ 2.2.7.2 å¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ <code>e</code> ï¼Œåˆ™ <code>promise2</code> å¿…é¡»æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›æ‹’å›  <code>e</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> promise2 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">+                   <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                        resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">+                   &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">+                       reject(e); <span class="comment">// æ•è·å‰é¢onFulfilledä¸­æŠ›å‡ºçš„å¼‚å¸¸</span></span><br><span class="line">+                   &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">+                   <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                        resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">+                   &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">+                       reject(e)</span><br><span class="line">+                   &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">                <span class="built_in">this</span>.onFulfilledCallbacks.push(onFulfilled);</span><br><span class="line">                <span class="built_in">this</span>.onRejectedCallbacks.push(onRejected);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;promise&#125;</span> </span>promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>resolve   promise2çš„resolveæ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>reject    promise2çš„rejectæ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2, x, resolve, reject</span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>â—¾ <code>fulfilled</code> å’Œ <code>rejected</code> çŠ¶æ€å¤„ç†å®Œï¼Œä¸è¦å¿˜äº† <code>pending</code> çŠ¶æ€çš„æƒ…å†µ</strong></p>
<p>æˆ‘ä»¬åœ¨ <code>pending</code> çŠ¶æ€ä¿å­˜çš„ <code>resolve()</code> å’Œ <code>reject()</code> å›è°ƒä¹Ÿè¦ç¬¦åˆ <code>2.2.7.1 å’Œ 2.2.7.2 è§„èŒƒ</code>ï¼š</p>
<blockquote>
<p>å¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> è¿”å›ä¸€ä¸ªå€¼ <code>x</code> ï¼Œåˆ™è¿è¡Œ Promise è§£å†³è¿‡ç¨‹ï¼š<code>[[Resolve]](promise2, x)</code></p>
</blockquote>
<blockquote>
<p>å¦‚æœ <code>onFulfilled</code> æˆ–è€… <code>onRejected</code> æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ <code>e</code> ï¼Œåˆ™ <code>promise2</code> å¿…é¡»æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›æ‹’å›  <code>e</code></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> promise2 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                        resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        reject(e); <span class="comment">// æ•è·å‰é¢onFulfilledä¸­æŠ›å‡ºçš„å¼‚å¸¸</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                        resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        reject(e)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">+               <span class="built_in">this</span>.onFulfilledCallbacks.push(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">+                   <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">+                       <span class="keyword">try</span> &#123;</span><br><span class="line">+                           <span class="keyword">let</span> x = onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">+                           resolvePromise(promise2, x, resolve, reject)</span><br><span class="line">+                       &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">+                           reject(e);</span><br><span class="line">+                       &#125;</span><br><span class="line">+                   &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="built_in">this</span>.onRejectedCallbacks.push(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">+                   <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">+                       <span class="keyword">try</span> &#123;</span><br><span class="line">+                           <span class="keyword">let</span> x = onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">+                           resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">+                       &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">+                           reject(e);</span><br><span class="line">+                       &#125;</span><br><span class="line">+                   &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;promise&#125;</span> </span>promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>resolve   promise2çš„resolveæ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>reject    promise2çš„rejectæ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2, x, resolve, reject</span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>æå®š <code>then</code> æ–¹æ³• ğŸ˜</p>
<p>ä¸‹é¢æˆ‘ä»¬å¼€å§‹ç€æ‰‹å†™ <strong>promise è§£å†³è¿‡ç¨‹ <code>resolvePromise(promise2, x, resolve, reject)</code></strong></p>
<h1 id="å…­ã€å®ç°-resolvePromise-æ–¹æ³•"><a href="#å…­ã€å®ç°-resolvePromise-æ–¹æ³•" class="headerlink" title="å…­ã€å®ç° resolvePromise æ–¹æ³•"></a>å…­ã€å®ç° resolvePromise æ–¹æ³•</h1><p><strong>â—¾ 2.3.1 å¦‚æœ <code>promise</code> å’Œ <code>x</code> æŒ‡å‘åŒä¸€å¯¹è±¡ï¼Œä»¥ <code>TypeError</code> ä¸ºæ®å› æ‹’ç»æ‰§è¡Œ <code>promise</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function">() =&gt;</span> &#123;&#125;;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function">() =&gt;</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> promise2 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                        resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        reject(e); <span class="comment">// æ•è·å‰é¢onFulfilledä¸­æŠ›å‡ºçš„å¼‚å¸¸</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                        resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        reject(e)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">                <span class="built_in">this</span>.onFulfilledCallbacks.push(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                            resolvePromise(promise2, x, resolve, reject)</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                            reject(e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="built_in">this</span>.onRejectedCallbacks.push(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                            resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                            reject(e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;promise&#125;</span> </span>promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>resolve   promise2çš„resolveæ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>reject    promise2çš„rejectæ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2, x, resolve, reject</span>) </span>&#123;</span><br><span class="line">	<span class="comment">// å¦‚æœä»onFulfilledæˆ–onRejectedä¸­è¿”å›çš„ x å°±æ˜¯promise2ï¼Œä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨æŠ¥é”™</span></span><br><span class="line">+   <span class="keyword">if</span> (x === promise2) &#123;</span><br><span class="line">+       <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise&#x27;</span>));</span><br><span class="line">+   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ä¸‹é¢è¿™ç§æƒ…å†µğŸ‘‡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const promise = new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">  resolve(100)</span><br><span class="line">&#125;)</span><br><span class="line">const p1 = promise.then(value =&gt; &#123;</span><br><span class="line">  console.log(value)</span><br><span class="line">  return p1</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨åŸç”Ÿ Promise æ‰§è¡Œè¿™ä¸ªä»£ç ï¼Œä¼šæŠ¥ç±»å‹é”™è¯¯ï¼š</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/02/08/JS-Promise%E7%9A%84%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/image-20220208160619270.png"
                      class="" title="image-20220208160619270"
                >

<p><strong>â—¾ 2.3.2 å¦‚æœ <code>x</code> ä¸º Promise ï¼Œåˆ™ä½¿ <code>promise</code> æ¥å— <code>x</code> çš„çŠ¶æ€</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;promise&#125;</span> </span>promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>resolve   promise2çš„resolveæ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>reject    promise2çš„rejectæ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2, x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x === promise2) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.3.2 å¦‚æœ x ä¸º Promise ï¼Œåˆ™ä½¿ promise2 æ¥å— x çš„çŠ¶æ€</span></span><br><span class="line">+   <span class="keyword">if</span> (x <span class="keyword">instanceof</span> myPromise) &#123;</span><br><span class="line">+       <span class="keyword">if</span> (x.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">+           <span class="comment">/**</span></span><br><span class="line"><span class="comment">+            * 2.3.2.1 å¦‚æœ x å¤„äºç­‰å¾…æ€ï¼Œ promise éœ€ä¿æŒä¸ºç­‰å¾…æ€ç›´è‡³ x è¢«æ‰§è¡Œæˆ–æ‹’ç»</span></span><br><span class="line"><span class="comment">+            *         æ³¨æ„&quot;ç›´è‡³ x è¢«æ‰§è¡Œæˆ–æ‹’ç»&quot;è¿™å¥è¯ï¼Œ</span></span><br><span class="line"><span class="comment">+            *         è¿™å¥è¯çš„æ„æ€æ˜¯ï¼šx è¢«æ‰§è¡Œxï¼Œå¦‚æœæ‰§è¡Œçš„æ—¶å€™æ‹¿åˆ°ä¸€ä¸ªyï¼Œè¿˜è¦ç»§ç»­è§£æy</span></span><br><span class="line"><span class="comment">+            */</span></span><br><span class="line">+           x.then(<span class="function"><span class="params">y</span> =&gt;</span> &#123;</span><br><span class="line">+               resolvePromise(promise2, y, resolve, reject)</span><br><span class="line">+           &#125;, reject);</span><br><span class="line">+       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">+           <span class="comment">// 2.3.2.2 å¦‚æœ x å¤„äºæ‰§è¡Œæ€ï¼Œç”¨ç›¸åŒçš„å€¼æ‰§è¡Œ promise</span></span><br><span class="line">+           resolve(x.PromiseResult);</span><br><span class="line">+       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">+           <span class="comment">// 2.3.2.3 å¦‚æœ x å¤„äºæ‹’ç»æ€ï¼Œç”¨ç›¸åŒçš„æ®å› æ‹’ç» promise</span></span><br><span class="line">+           reject(x.PromiseResult);</span><br><span class="line">+       &#125;</span><br><span class="line">+   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é©¬ä¸Šå°±è¦æˆåŠŸå•¦ğŸ˜¸ï¼Œè¿˜æœ‰æœ€åä¸€æ¡ğŸ˜</p>
<p>â—¾ 2.3.3 å¦‚æœ <code>x</code> ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°</p>
<p><strong>â—¾ 2.3.4 å¦‚æœ <code>x</code> ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ <code>x</code> ä¸ºå‚æ•°æ‰§è¡Œ <code>promise</code></strong></p>
<p>åœ¨åˆ¤æ–­<code>x</code>æ˜¯å¯¹è±¡æˆ–å‡½æ•°æ—¶ï¼Œ<code>x</code> ä¸èƒ½æ˜¯ <code>null</code>ï¼Œå› ä¸º <code>typeof null</code>çš„å€¼ä¹Ÿä¸º <code>object</code></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/02/08/JS-Promise%E7%9A%84%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/image-20220208160738109.png"
                      class="" title="image-20220208160738109"
                >

<p>æˆ‘ä»¬åº”è¯¥æ˜¾å¼çš„å£°æ˜ <code>x != null</code>ï¼Œè¿™æ · å½“ <code>x</code> ä¸º <code>null</code> æ—¶ï¼Œç›´æ¥æ‰§è¡Œ<code>resolve(x)</code>ï¼Œå¦åˆ™ï¼Œå¦‚æœä¸è¿™æ ·ä¸å£°æ˜ï¼Œ<code>x</code> ä¸º <code>null</code> æ—¶å°±ä¼šèµ°åˆ°<code>catch</code>ç„¶å<code>reject</code>ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬è¦çš„ï¼Œæ‰€ä»¥éœ€è¦æ£€æµ‹ä¸‹<code>null</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (x != null &amp;&amp; ((typeof x === &#x27;object&#x27; || (typeof x === &#x27;function&#x27;))))</span><br></pre></td></tr></table></figure>

<p><strong>â—¾ 2.3.3 å’Œ 2.3.4 è§„èŒƒå®ç°å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;promise&#125;</span> </span>promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>resolve   promise2çš„resolveæ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>reject    promise2çš„rejectæ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2, x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x === promise2) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.3.2 å¦‚æœ x ä¸º Promise ï¼Œåˆ™ä½¿ promise2 æ¥å— x çš„çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (x <span class="keyword">instanceof</span> myPromise) &#123;</span><br><span class="line">        <span class="keyword">if</span> (x.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 2.3.2.1 å¦‚æœ x å¤„äºç­‰å¾…æ€ï¼Œ promise éœ€ä¿æŒä¸ºç­‰å¾…æ€ç›´è‡³ x è¢«æ‰§è¡Œæˆ–æ‹’ç»</span></span><br><span class="line"><span class="comment">             *         æ³¨æ„&quot;ç›´è‡³ x è¢«æ‰§è¡Œæˆ–æ‹’ç»&quot;è¿™å¥è¯ï¼Œ</span></span><br><span class="line"><span class="comment">             *         è¿™å¥è¯çš„æ„æ€æ˜¯ï¼šx è¢«æ‰§è¡Œxï¼Œå¦‚æœæ‰§è¡Œçš„æ—¶å€™æ‹¿åˆ°ä¸€ä¸ªyï¼Œè¿˜è¦ç»§ç»­è§£æy</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            x.then(<span class="function"><span class="params">y</span> =&gt;</span> &#123;</span><br><span class="line">                resolvePromise(promise2, y, resolve, reject)</span><br><span class="line">            &#125;, reject);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            <span class="comment">// 2.3.2.2 å¦‚æœ x å¤„äºæ‰§è¡Œæ€ï¼Œç”¨ç›¸åŒçš„å€¼æ‰§è¡Œ promise</span></span><br><span class="line">            resolve(x.PromiseResult);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            <span class="comment">// 2.3.2.3 å¦‚æœ x å¤„äºæ‹’ç»æ€ï¼Œç”¨ç›¸åŒçš„æ®å› æ‹’ç» promise</span></span><br><span class="line">            reject(x.PromiseResult);</span><br><span class="line">        &#125;</span><br><span class="line">+   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x !== <span class="literal">null</span> &amp;&amp; ((<span class="keyword">typeof</span> x === <span class="string">&#x27;object&#x27;</span> || (<span class="keyword">typeof</span> x === <span class="string">&#x27;function&#x27;</span>)))) &#123;</span><br><span class="line">+       <span class="comment">// 2.3.3 å¦‚æœ x ä¸ºå¯¹è±¡æˆ–å‡½æ•°</span></span><br><span class="line">+       <span class="keyword">try</span> &#123;</span><br><span class="line">+           <span class="comment">// 2.3.3.1 æŠŠ x.then èµ‹å€¼ç»™ then</span></span><br><span class="line">+           <span class="keyword">var</span> then = x.then;</span><br><span class="line">+       &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">+           <span class="comment">// 2.3.3.2 å¦‚æœå– x.then çš„å€¼æ—¶æŠ›å‡ºé”™è¯¯ e ï¼Œåˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise</span></span><br><span class="line">+           <span class="keyword">return</span> reject(e);</span><br><span class="line">+       &#125;</span><br><span class="line">+</span><br><span class="line">+       <span class="comment">/**</span></span><br><span class="line"><span class="comment">+        * 2.3.3.3 </span></span><br><span class="line"><span class="comment">+        * å¦‚æœ then æ˜¯å‡½æ•°ï¼Œå°† x ä½œä¸ºå‡½æ•°çš„ä½œç”¨åŸŸ this è°ƒç”¨ä¹‹ã€‚</span></span><br><span class="line"><span class="comment">+        * ä¼ é€’ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œ</span></span><br><span class="line"><span class="comment">+        * ç¬¬ä¸€ä¸ªå‚æ•°å«åš `resolvePromise` ï¼Œç¬¬äºŒä¸ªå‚æ•°å«åš `rejectPromise`</span></span><br><span class="line"><span class="comment">+        */</span></span><br><span class="line">+       <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">+           <span class="comment">// 2.3.3.3.3 å¦‚æœ resolvePromise å’Œ rejectPromise å‡è¢«è°ƒç”¨ï¼Œæˆ–è€…è¢«åŒä¸€å‚æ•°è°ƒç”¨äº†å¤šæ¬¡ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨é¦–æ¬¡è°ƒç”¨å¹¶å¿½ç•¥å‰©ä¸‹çš„è°ƒç”¨</span></span><br><span class="line">+           <span class="keyword">let</span> called = <span class="literal">false</span>; <span class="comment">// é¿å…å¤šæ¬¡è°ƒç”¨</span></span><br><span class="line">+           <span class="keyword">try</span> &#123;</span><br><span class="line">+               then.call(</span><br><span class="line">+                   x,</span><br><span class="line">+                   <span class="comment">// 2.3.3.3.1 å¦‚æœ resolvePromise ä»¥å€¼ y ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™è¿è¡Œ [[Resolve]](promise, y)</span></span><br><span class="line">+                   <span class="function"><span class="params">y</span> =&gt;</span> &#123;</span><br><span class="line">+                       <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">+                       called = <span class="literal">true</span>;</span><br><span class="line">+                       resolvePromise(promise2, y, resolve, reject);</span><br><span class="line">+                   &#125;,</span><br><span class="line">+                   <span class="comment">// 2.3.3.3.2 å¦‚æœ rejectPromise ä»¥æ®å›  r ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™ä»¥æ®å›  r æ‹’ç» promise</span></span><br><span class="line">+                   <span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">+                       <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">+                       called = <span class="literal">true</span>;</span><br><span class="line">+                       reject(r);</span><br><span class="line">+                   &#125;</span><br><span class="line">+               )</span><br><span class="line">+           &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">+               <span class="comment">/**</span></span><br><span class="line"><span class="comment">+                * 2.3.3.3.4 å¦‚æœè°ƒç”¨ then æ–¹æ³•æŠ›å‡ºäº†å¼‚å¸¸ e</span></span><br><span class="line"><span class="comment">+                * 2.3.3.3.4.1 å¦‚æœ resolvePromise æˆ– rejectPromise å·²ç»è¢«è°ƒç”¨ï¼Œåˆ™å¿½ç•¥ä¹‹</span></span><br><span class="line"><span class="comment">+                */</span></span><br><span class="line">+               <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">+               called = <span class="literal">true</span>;</span><br><span class="line">+</span><br><span class="line">+               <span class="comment">/**</span></span><br><span class="line"><span class="comment">+                * 2.3.3.3.4.2 å¦åˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise</span></span><br><span class="line"><span class="comment">+                */</span></span><br><span class="line">+               reject(e);</span><br><span class="line">+           &#125;</span><br><span class="line">+       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">+           <span class="comment">// 2.3.3.4 å¦‚æœ then ä¸æ˜¯å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise</span></span><br><span class="line">+           resolve(x);</span><br><span class="line">+       &#125;</span><br><span class="line">+   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">+       <span class="comment">// 2.3.4 å¦‚æœ x ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise</span></span><br><span class="line">+       <span class="keyword">return</span> resolve(x);</span><br><span class="line">+   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ‰“å®Œæ”¶å·¥âœ¨âœ¨âœ¨âœ¨</strong></p>
<p><strong><code>resolvePromise()</code>æ–¹æ³• å®Œæ•´ä»£ç ï¼š</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;promise&#125;</span> </span>promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>resolve   promise2çš„resolveæ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>reject    promise2çš„rejectæ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2, x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x === promise2) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.3.2 å¦‚æœ x ä¸º Promise ï¼Œåˆ™ä½¿ promise2 æ¥å— x çš„çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (x <span class="keyword">instanceof</span> myPromise) &#123;</span><br><span class="line">        <span class="keyword">if</span> (x.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 2.3.2.1 å¦‚æœ x å¤„äºç­‰å¾…æ€ï¼Œ promise éœ€ä¿æŒä¸ºç­‰å¾…æ€ç›´è‡³ x è¢«æ‰§è¡Œæˆ–æ‹’ç»</span></span><br><span class="line"><span class="comment">             *         æ³¨æ„&quot;ç›´è‡³ x è¢«æ‰§è¡Œæˆ–æ‹’ç»&quot;è¿™å¥è¯ï¼Œ</span></span><br><span class="line"><span class="comment">             *         è¿™å¥è¯çš„æ„æ€æ˜¯ï¼šx è¢«æ‰§è¡Œxï¼Œå¦‚æœæ‰§è¡Œçš„æ—¶å€™æ‹¿åˆ°ä¸€ä¸ªyï¼Œè¿˜è¦ç»§ç»­è§£æy</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            x.then(<span class="function"><span class="params">y</span> =&gt;</span> &#123;</span><br><span class="line">                resolvePromise(promise2, y, resolve, reject)</span><br><span class="line">            &#125;, reject);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            <span class="comment">// 2.3.2.2 å¦‚æœ x å¤„äºæ‰§è¡Œæ€ï¼Œç”¨ç›¸åŒçš„å€¼æ‰§è¡Œ promise</span></span><br><span class="line">            resolve(x.PromiseResult);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            <span class="comment">// 2.3.2.3 å¦‚æœ x å¤„äºæ‹’ç»æ€ï¼Œç”¨ç›¸åŒçš„æ®å› æ‹’ç» promise</span></span><br><span class="line">            reject(x.PromiseResult);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x !== <span class="literal">null</span> &amp;&amp; ((<span class="keyword">typeof</span> x === <span class="string">&#x27;object&#x27;</span> || (<span class="keyword">typeof</span> x === <span class="string">&#x27;function&#x27;</span>)))) &#123;</span><br><span class="line">        <span class="comment">// 2.3.3 å¦‚æœ x ä¸ºå¯¹è±¡æˆ–å‡½æ•°</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2.3.3.1 æŠŠ x.then èµ‹å€¼ç»™ then</span></span><br><span class="line">            <span class="keyword">var</span> then = x.then;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="comment">// 2.3.3.2 å¦‚æœå– x.then çš„å€¼æ—¶æŠ›å‡ºé”™è¯¯ e ï¼Œåˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise</span></span><br><span class="line">            <span class="keyword">return</span> reject(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 2.3.3.3 </span></span><br><span class="line"><span class="comment">         * å¦‚æœ then æ˜¯å‡½æ•°ï¼Œå°† x ä½œä¸ºå‡½æ•°çš„ä½œç”¨åŸŸ this è°ƒç”¨ä¹‹ã€‚</span></span><br><span class="line"><span class="comment">         * ä¼ é€’ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œ</span></span><br><span class="line"><span class="comment">         * ç¬¬ä¸€ä¸ªå‚æ•°å«åš `resolvePromise` ï¼Œç¬¬äºŒä¸ªå‚æ•°å«åš `rejectPromise`</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// 2.3.3.3.3 å¦‚æœ resolvePromise å’Œ rejectPromise å‡è¢«è°ƒç”¨ï¼Œæˆ–è€…è¢«åŒä¸€å‚æ•°è°ƒç”¨äº†å¤šæ¬¡ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨é¦–æ¬¡è°ƒç”¨å¹¶å¿½ç•¥å‰©ä¸‹çš„è°ƒç”¨</span></span><br><span class="line">            <span class="keyword">let</span> called = <span class="literal">false</span>; <span class="comment">// é¿å…å¤šæ¬¡è°ƒç”¨</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                then.call(</span><br><span class="line">                    x,</span><br><span class="line">                    <span class="comment">// 2.3.3.3.1 å¦‚æœ resolvePromise ä»¥å€¼ y ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™è¿è¡Œ [[Resolve]](promise, y)</span></span><br><span class="line">                    <span class="function"><span class="params">y</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">                        called = <span class="literal">true</span>;</span><br><span class="line">                        resolvePromise(promise2, y, resolve, reject);</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="comment">// 2.3.3.3.2 å¦‚æœ rejectPromise ä»¥æ®å›  r ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™ä»¥æ®å›  r æ‹’ç» promise</span></span><br><span class="line">                    <span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">                        called = <span class="literal">true</span>;</span><br><span class="line">                        reject(r);</span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 2.3.3.3.4 å¦‚æœè°ƒç”¨ then æ–¹æ³•æŠ›å‡ºäº†å¼‚å¸¸ e</span></span><br><span class="line"><span class="comment">                 * 2.3.3.3.4.1 å¦‚æœ resolvePromise æˆ– rejectPromise å·²ç»è¢«è°ƒç”¨ï¼Œåˆ™å¿½ç•¥ä¹‹</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">                called = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 2.3.3.3.4.2 å¦åˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                reject(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 2.3.3.4 å¦‚æœ then ä¸æ˜¯å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise</span></span><br><span class="line">            resolve(x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 2.3.4 å¦‚æœ x ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise</span></span><br><span class="line">        <span class="keyword">return</span> resolve(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ä¸ƒã€å®Œæ•´çš„-Promises-A-å®ç°"><a href="#ä¸ƒã€å®Œæ•´çš„-Promises-A-å®ç°" class="headerlink" title="ä¸ƒã€å®Œæ•´çš„ Promises/A+ å®ç°"></a>ä¸ƒã€å®Œæ•´çš„ Promises/A+ å®ç°</h1><p>åˆ°è¿™é‡Œæˆ‘ä»¬çš„<code>myPromsie</code>å·²ç»å®Œæˆäº† <strong>Promises/A+ è§„èŒƒ</strong> ğŸ˜¸</p>
<blockquote>
<p>ES6çš„å®˜æ–¹Promiseè¿˜æœ‰å¾ˆå¤šAPIï¼Œä½†è¿™äº›éƒ½ä¸åœ¨Promises/A+é‡Œé¢</p>
</blockquote>
<p>è¿™é‡Œä¸ºå¤§å®¶æä¾›äº†ä¸¤ä¸ªå®Œæ•´çš„ Promises/A+ å®ç°ç‰ˆæœ¬ï¼š</p>
<h2 id="1-æ¸…çˆ½ç®€æ´-æ— æ³¨é‡Šç‰ˆ"><a href="#1-æ¸…çˆ½ç®€æ´-æ— æ³¨é‡Šç‰ˆ" class="headerlink" title="1. æ¸…çˆ½ç®€æ´ æ— æ³¨é‡Šç‰ˆ"></a>1. æ¸…çˆ½ç®€æ´ æ— æ³¨é‡Šç‰ˆ</h2><p><strong>å®Œæ•´çš„ Promises/A+ å®ç° <code>(æ¸…çˆ½ç®€æ´ æ— æ³¨é‡Šç‰ˆ)</code>ï¼š</strong></p>
<p><em>å®Œæ•´ç‰ˆçš„ä»£ç è¾ƒé•¿ï¼Œè¿™é‡Œå¦‚æœçœ‹ä¸æ¸…æ¥šçš„å¯ä»¥å»æˆ‘çš„GitHubä¸Šçœ‹ï¼Œæˆ‘ä¸“é—¨ç»´æŠ¤äº†ä¸€ä¸ª æ‰‹å†™ Promsie çš„ä»“åº“</em>ï¼š<a class="link"   target="_blank" rel="noopener" href="https://github.com/yuanyuanbyte/Promise%E2%80%8D" >https://github.com/yuanyuanbyte/Promiseâ€<i class="fas fa-external-link-alt"></i></a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING;</span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.onFulfilledCallbacks = [];</span><br><span class="line">        <span class="built_in">this</span>.onRejectedCallbacks = [];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="built_in">this</span>.reject(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">                <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">                <span class="built_in">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                    callback(result)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">                <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">                <span class="built_in">this</span>.onRejectedCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                    callback(reason)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> promise2 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                        resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        reject(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                        resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        reject(e)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">                <span class="built_in">this</span>.onFulfilledCallbacks.push(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                            resolvePromise(promise2, x, resolve, reject)</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                            reject(e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="built_in">this</span>.onRejectedCallbacks.push(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                            resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                            reject(e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2, x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x === promise2) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (x <span class="keyword">instanceof</span> myPromise) &#123;</span><br><span class="line">        <span class="keyword">if</span> (x.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            x.then(<span class="function"><span class="params">y</span> =&gt;</span> &#123;</span><br><span class="line">                resolvePromise(promise2, y, resolve, reject)</span><br><span class="line">            &#125;, reject);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            resolve(x.PromiseResult);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            reject(x.PromiseResult);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x !== <span class="literal">null</span> &amp;&amp; ((<span class="keyword">typeof</span> x === <span class="string">&#x27;object&#x27;</span> || (<span class="keyword">typeof</span> x === <span class="string">&#x27;function&#x27;</span>)))) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> then = x.then;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">return</span> reject(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> called = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                then.call(</span><br><span class="line">                    x,</span><br><span class="line">                    <span class="function"><span class="params">y</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">                        called = <span class="literal">true</span>;</span><br><span class="line">                        resolvePromise(promise2, y, resolve, reject);</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">                        called = <span class="literal">true</span>;</span><br><span class="line">                        reject(r);</span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">                called = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                reject(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolve(x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> resolve(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-æŒ‰æ­¥åˆ†æ-æ³¨é‡ŠåŠ æŒç‰ˆ"><a href="#2-æŒ‰æ­¥åˆ†æ-æ³¨é‡ŠåŠ æŒç‰ˆ" class="headerlink" title="2. æŒ‰æ­¥åˆ†æ æ³¨é‡ŠåŠ æŒç‰ˆ"></a>2. æŒ‰æ­¥åˆ†æ æ³¨é‡ŠåŠ æŒç‰ˆ</h2><p><strong>å®Œæ•´çš„ Promises/A+ å®ç° <code>(æŒ‰æ­¥åˆ†æ æ³¨é‡ŠåŠ æŒç‰ˆ)</code>ï¼š</strong></p>
<p><em>å®Œæ•´ç‰ˆçš„ä»£ç è¾ƒé•¿ï¼Œè¿™é‡Œå¦‚æœçœ‹ä¸æ¸…æ¥šçš„å¯ä»¥å»æˆ‘çš„GitHubä¸Šçœ‹ï¼Œæˆ‘ä¸“é—¨ç»´æŠ¤äº†ä¸€ä¸ª æ‰‹å†™ Promsie çš„ä»“åº“</em>ï¼š<a class="link"   target="_blank" rel="noopener" href="https://github.com/yuanyuanbyte/Promise%E2%80%8D" >https://github.com/yuanyuanbyte/Promiseâ€<i class="fas fa-external-link-alt"></i></a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸ºäº†ç»Ÿä¸€ç”¨staticåˆ›å»ºé™æ€å±æ€§ï¼Œç”¨æ¥ç®¡ç†çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">static</span> PENDING = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> FULFILLED = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line">    <span class="keyword">static</span> REJECTED = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°ï¼šé€šè¿‡newå‘½ä»¤ç”Ÿæˆå¯¹è±¡å®ä¾‹æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">func</span>)</span> &#123; <span class="comment">// ç»™ç±»çš„æ„é€ æ–¹æ³•constructoræ·»åŠ ä¸€ä¸ªå‚æ•°func</span></span><br><span class="line">        <span class="built_in">this</span>.PromiseState = myPromise.PENDING; <span class="comment">// æŒ‡å®šPromiseå¯¹è±¡çš„çŠ¶æ€å±æ€§ PromiseStateï¼Œåˆå§‹å€¼ä¸ºpending</span></span><br><span class="line">        <span class="built_in">this</span>.PromiseResult = <span class="literal">null</span>; <span class="comment">// æŒ‡å®šPromiseå¯¹è±¡çš„ç»“æœ PromiseResult</span></span><br><span class="line">        <span class="built_in">this</span>.onFulfilledCallbacks = []; <span class="comment">// ä¿å­˜æˆåŠŸå›è°ƒ</span></span><br><span class="line">        <span class="built_in">this</span>.onRejectedCallbacks = []; <span class="comment">// ä¿å­˜å¤±è´¥å›è°ƒ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * func()ä¼ å…¥resolveå’Œrejectï¼Œ</span></span><br><span class="line"><span class="comment">             * resolve()å’Œreject()æ–¹æ³•åœ¨å¤–éƒ¨è°ƒç”¨ï¼Œè¿™é‡Œéœ€è¦ç”¨bindä¿®æ­£ä¸€ä¸‹thisæŒ‡å‘</span></span><br><span class="line"><span class="comment">             * new å¯¹è±¡å®ä¾‹æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œfunc()</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            func(<span class="built_in">this</span>.resolve.bind(<span class="built_in">this</span>), <span class="built_in">this</span>.reject.bind(<span class="built_in">this</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="comment">// ç”Ÿæˆå®ä¾‹æ—¶(æ‰§è¡Œresolveå’Œreject)ï¼Œå¦‚æœæŠ¥é”™ï¼Œå°±æŠŠé”™è¯¯ä¿¡æ¯ä¼ å…¥ç»™reject()æ–¹æ³•ï¼Œå¹¶ä¸”ç›´æ¥æ‰§è¡Œreject()æ–¹æ³•</span></span><br><span class="line">            <span class="built_in">this</span>.reject(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">resolve</span>(<span class="params">result</span>)</span> &#123; <span class="comment">// resultä¸ºæˆåŠŸæ€æ—¶æ¥æ”¶çš„ç»ˆå€¼</span></span><br><span class="line">        <span class="comment">// åªèƒ½ç”±pedningçŠ¶æ€ =&gt; fulfilledçŠ¶æ€ (é¿å…è°ƒç”¨å¤šæ¬¡resolve reject)</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ä¸ºä»€ä¹ˆresolveå’Œrejectè¦åŠ setTimeout?</span></span><br><span class="line"><span class="comment">             * 2.2.4è§„èŒƒ onFulfilled å’Œ onRejected åªå…è®¸åœ¨ execution context æ ˆä»…åŒ…å«å¹³å°ä»£ç æ—¶è¿è¡Œ.</span></span><br><span class="line"><span class="comment">             * æ³¨1 è¿™é‡Œçš„å¹³å°ä»£ç æŒ‡çš„æ˜¯å¼•æ“ã€ç¯å¢ƒä»¥åŠ promise çš„å®æ–½ä»£ç ã€‚å®è·µä¸­è¦ç¡®ä¿ onFulfilled å’Œ onRejected æ–¹æ³•å¼‚æ­¥æ‰§è¡Œï¼Œä¸”åº”è¯¥åœ¨ then æ–¹æ³•è¢«è°ƒç”¨çš„é‚£ä¸€è½®äº‹ä»¶å¾ªç¯ä¹‹åçš„æ–°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment">             * è¿™ä¸ªäº‹ä»¶é˜Ÿåˆ—å¯ä»¥é‡‡ç”¨â€œå®ä»»åŠ¡ï¼ˆmacro-taskï¼‰â€æœºåˆ¶ï¼Œæ¯”å¦‚setTimeout æˆ–è€… setImmediateï¼› ä¹Ÿå¯ä»¥é‡‡ç”¨â€œå¾®ä»»åŠ¡ï¼ˆmicro-taskï¼‰â€æœºåˆ¶æ¥å®ç°ï¼Œ æ¯”å¦‚ MutationObserver æˆ–è€…process.nextTickã€‚ </span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.PromiseState = myPromise.FULFILLED;</span><br><span class="line">                <span class="built_in">this</span>.PromiseResult = result;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * åœ¨æ‰§è¡Œresolveæˆ–è€…rejectçš„æ—¶å€™ï¼Œéå†è‡ªèº«çš„callbacksæ•°ç»„ï¼Œ</span></span><br><span class="line"><span class="comment">                 * çœ‹çœ‹æ•°ç»„é‡Œé¢æœ‰æ²¡æœ‰thené‚£è¾¹ ä¿ç•™ è¿‡æ¥çš„ å¾…æ‰§è¡Œå‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment">                 * ç„¶åé€ä¸ªæ‰§è¡Œæ•°ç»„é‡Œé¢çš„å‡½æ•°ï¼Œæ‰§è¡Œçš„æ—¶å€™ä¼šä¼ å…¥ç›¸åº”çš„å‚æ•°</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="built_in">this</span>.onFulfilledCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                    callback(result)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">reject</span>(<span class="params">reason</span>)</span> &#123; <span class="comment">// reasonä¸ºæ‹’ç»æ€æ—¶æ¥æ”¶çš„ç»ˆå€¼</span></span><br><span class="line">        <span class="comment">// åªèƒ½ç”±pedningçŠ¶æ€ =&gt; rejectedçŠ¶æ€ (é¿å…è°ƒç”¨å¤šæ¬¡resolve reject)</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.PromiseState = myPromise.REJECTED;</span><br><span class="line">                <span class="built_in">this</span>.PromiseResult = reason;</span><br><span class="line">                <span class="built_in">this</span>.onRejectedCallbacks.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">                    callback(reason)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * [æ³¨å†ŒfulfilledçŠ¶æ€/rejectedçŠ¶æ€å¯¹åº”çš„å›è°ƒå‡½æ•°] </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;function&#125;</span> </span>onFulfilled  fulfilledçŠ¶æ€æ—¶ æ‰§è¡Œçš„å‡½æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;function&#125;</span> </span>onRejected  rejectedçŠ¶æ€æ—¶ æ‰§è¡Œçš„å‡½æ•° </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@returns <span class="type">&#123;function&#125;</span> </span>newPromsie  è¿”å›ä¸€ä¸ªæ–°çš„promiseå¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="title">then</span>(<span class="params">onFulfilled, onRejected</span>)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å‚æ•°æ ¡éªŒï¼šPromiseè§„å®šthenæ–¹æ³•é‡Œé¢çš„ä¸¤ä¸ªå‚æ•°å¦‚æœä¸æ˜¯å‡½æ•°çš„è¯å°±è¦è¢«å¿½ç•¥</span></span><br><span class="line"><span class="comment">         * æ‰€è°“â€œå¿½ç•¥â€å¹¶ä¸æ˜¯ä»€ä¹ˆéƒ½ä¸å¹²ï¼Œ</span></span><br><span class="line"><span class="comment">         * å¯¹äºonFulfilledæ¥è¯´â€œå¿½ç•¥â€å°±æ˜¯å°†valueåŸå°ä¸åŠ¨çš„è¿”å›ï¼Œ</span></span><br><span class="line"><span class="comment">         * å¯¹äºonRejectedæ¥è¯´å°±æ˜¯è¿”å›reasonï¼Œ</span></span><br><span class="line"><span class="comment">         *     onRejectedå› ä¸ºæ˜¯é”™è¯¯åˆ†æ”¯ï¼Œæˆ‘ä»¬è¿”å›reasonåº”è¯¥throwä¸€ä¸ªError</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        onFulfilled = <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        onRejected = <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.2.7è§„èŒƒ then æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª promise å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">let</span> promise2 = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * ä¸ºä»€ä¹ˆè¿™é‡Œè¦åŠ å®šæ—¶å™¨setTimeoutï¼Ÿ</span></span><br><span class="line"><span class="comment">                 * 2.2.4è§„èŒƒ onFulfilled å’Œ onRejected åªæœ‰åœ¨æ‰§è¡Œç¯å¢ƒå †æ ˆä»…åŒ…å«å¹³å°ä»£ç æ—¶æ‰å¯è¢«è°ƒç”¨ æ³¨1</span></span><br><span class="line"><span class="comment">                 * è¿™é‡Œçš„å¹³å°ä»£ç æŒ‡çš„æ˜¯å¼•æ“ã€ç¯å¢ƒä»¥åŠ promise çš„å®æ–½ä»£ç ã€‚</span></span><br><span class="line"><span class="comment">                 * å®è·µä¸­è¦ç¡®ä¿ onFulfilled å’Œ onRejected æ–¹æ³•å¼‚æ­¥æ‰§è¡Œï¼Œä¸”åº”è¯¥åœ¨ then æ–¹æ³•è¢«è°ƒç”¨çš„é‚£ä¸€è½®äº‹ä»¶å¾ªç¯ä¹‹åçš„æ–°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment">                 * è¿™ä¸ªäº‹ä»¶é˜Ÿåˆ—å¯ä»¥é‡‡ç”¨â€œå®ä»»åŠ¡ï¼ˆmacro-taskï¼‰â€æœºåˆ¶ï¼Œæ¯”å¦‚setTimeout æˆ–è€… setImmediateï¼› ä¹Ÿå¯ä»¥é‡‡ç”¨â€œå¾®ä»»åŠ¡ï¼ˆmicro-taskï¼‰â€æœºåˆ¶æ¥å®ç°ï¼Œ æ¯”å¦‚ MutationObserver æˆ–è€…process.nextTickã€‚</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 2.2.7.1è§„èŒƒ å¦‚æœ onFulfilled æˆ–è€… onRejected è¿”å›ä¸€ä¸ªå€¼ x ï¼Œåˆ™è¿è¡Œä¸‹é¢çš„ Promise è§£å†³è¿‡ç¨‹ï¼š[[Resolve]](promise2, x)ï¼Œå³è¿è¡ŒresolvePromise()</span></span><br><span class="line">                        <span class="keyword">let</span> x = onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                        resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        <span class="comment">// 2.2.7.2 å¦‚æœ onFulfilled æˆ–è€… onRejected æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ e ï¼Œåˆ™ promise2 å¿…é¡»æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›æ‹’å›  e</span></span><br><span class="line">                        reject(e); <span class="comment">// æ•è·å‰é¢onFulfilledä¸­æŠ›å‡ºçš„å¼‚å¸¸</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                        resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        reject(e)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">                <span class="comment">// pending çŠ¶æ€ä¿å­˜çš„ resolve() å’Œ reject() å›è°ƒä¹Ÿè¦ç¬¦åˆ 2.2.7.1 å’Œ 2.2.7.2 è§„èŒƒ</span></span><br><span class="line">                <span class="built_in">this</span>.onFulfilledCallbacks.push(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = onFulfilled(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                            resolvePromise(promise2, x, resolve, reject)</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                            reject(e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="built_in">this</span>.onRejectedCallbacks.push(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = onRejected(<span class="built_in">this</span>.PromiseResult);</span><br><span class="line">                            resolvePromise(promise2, x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                            reject(e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;promise&#125;</span> </span>promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>resolve   promise2çš„resolveæ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>reject    promise2çš„rejectæ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2, x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 2.3.1è§„èŒƒ å¦‚æœ promise å’Œ x æŒ‡å‘åŒä¸€å¯¹è±¡ï¼Œä»¥ TypeError ä¸ºæ®å› æ‹’ç»æ‰§è¡Œ promise</span></span><br><span class="line">    <span class="keyword">if</span> (x === promise2) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.3.2è§„èŒƒ å¦‚æœ x ä¸º Promise ï¼Œåˆ™ä½¿ promise2 æ¥å— x çš„çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (x <span class="keyword">instanceof</span> myPromise) &#123;</span><br><span class="line">        <span class="keyword">if</span> (x.PromiseState === myPromise.PENDING) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 2.3.2.1 å¦‚æœ x å¤„äºç­‰å¾…æ€ï¼Œ promise éœ€ä¿æŒä¸ºç­‰å¾…æ€ç›´è‡³ x è¢«æ‰§è¡Œæˆ–æ‹’ç»</span></span><br><span class="line"><span class="comment">             *         æ³¨æ„&quot;ç›´è‡³ x è¢«æ‰§è¡Œæˆ–æ‹’ç»&quot;è¿™å¥è¯ï¼Œ</span></span><br><span class="line"><span class="comment">             *         è¿™å¥è¯çš„æ„æ€æ˜¯ï¼šx è¢«æ‰§è¡Œxï¼Œå¦‚æœæ‰§è¡Œçš„æ—¶å€™æ‹¿åˆ°ä¸€ä¸ªyï¼Œè¿˜è¦ç»§ç»­è§£æy</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            x.then(<span class="function"><span class="params">y</span> =&gt;</span> &#123;</span><br><span class="line">                resolvePromise(promise2, y, resolve, reject)</span><br><span class="line">            &#125;, reject);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x.PromiseState === myPromise.FULFILLED) &#123;</span><br><span class="line">            <span class="comment">// 2.3.2.2 å¦‚æœ x å¤„äºæ‰§è¡Œæ€ï¼Œç”¨ç›¸åŒçš„å€¼æ‰§è¡Œ promise</span></span><br><span class="line">            resolve(x.PromiseResult);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x.PromiseState === myPromise.REJECTED) &#123;</span><br><span class="line">            <span class="comment">// 2.3.2.3 å¦‚æœ x å¤„äºæ‹’ç»æ€ï¼Œç”¨ç›¸åŒçš„æ®å› æ‹’ç» promise</span></span><br><span class="line">            reject(x.PromiseResult);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x !== <span class="literal">null</span> &amp;&amp; ((<span class="keyword">typeof</span> x === <span class="string">&#x27;object&#x27;</span> || (<span class="keyword">typeof</span> x === <span class="string">&#x27;function&#x27;</span>)))) &#123;</span><br><span class="line">        <span class="comment">// 2.3.3 å¦‚æœ x ä¸ºå¯¹è±¡æˆ–å‡½æ•°</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2.3.3.1 æŠŠ x.then èµ‹å€¼ç»™ then</span></span><br><span class="line">            <span class="keyword">var</span> then = x.then;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="comment">// 2.3.3.2 å¦‚æœå– x.then çš„å€¼æ—¶æŠ›å‡ºé”™è¯¯ e ï¼Œåˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise</span></span><br><span class="line">            <span class="keyword">return</span> reject(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 2.3.3.3 </span></span><br><span class="line"><span class="comment">         * å¦‚æœ then æ˜¯å‡½æ•°ï¼Œå°† x ä½œä¸ºå‡½æ•°çš„ä½œç”¨åŸŸ this è°ƒç”¨ä¹‹ã€‚</span></span><br><span class="line"><span class="comment">         * ä¼ é€’ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œ</span></span><br><span class="line"><span class="comment">         * ç¬¬ä¸€ä¸ªå‚æ•°å«åš `resolvePromise` ï¼Œç¬¬äºŒä¸ªå‚æ•°å«åš `rejectPromise`</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// 2.3.3.3.3 å¦‚æœ resolvePromise å’Œ rejectPromise å‡è¢«è°ƒç”¨ï¼Œæˆ–è€…è¢«åŒä¸€å‚æ•°è°ƒç”¨äº†å¤šæ¬¡ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨é¦–æ¬¡è°ƒç”¨å¹¶å¿½ç•¥å‰©ä¸‹çš„è°ƒç”¨</span></span><br><span class="line">            <span class="keyword">let</span> called = <span class="literal">false</span>; <span class="comment">// é¿å…å¤šæ¬¡è°ƒç”¨</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                then.call(</span><br><span class="line">                    x,</span><br><span class="line">                    <span class="comment">// 2.3.3.3.1 å¦‚æœ resolvePromise ä»¥å€¼ y ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™è¿è¡Œ [[Resolve]](promise, y)</span></span><br><span class="line">                    <span class="function"><span class="params">y</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">                        called = <span class="literal">true</span>;</span><br><span class="line">                        resolvePromise(promise2, y, resolve, reject);</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="comment">// 2.3.3.3.2 å¦‚æœ rejectPromise ä»¥æ®å›  r ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™ä»¥æ®å›  r æ‹’ç» promise</span></span><br><span class="line">                    <span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">                        called = <span class="literal">true</span>;</span><br><span class="line">                        reject(r);</span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 2.3.3.3.4 å¦‚æœè°ƒç”¨ then æ–¹æ³•æŠ›å‡ºäº†å¼‚å¸¸ e</span></span><br><span class="line"><span class="comment">                 * 2.3.3.3.4.1 å¦‚æœ resolvePromise æˆ– rejectPromise å·²ç»è¢«è°ƒç”¨ï¼Œåˆ™å¿½ç•¥ä¹‹</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> (called) <span class="keyword">return</span>;</span><br><span class="line">                called = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 2.3.3.3.4.2 å¦åˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                reject(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 2.3.3.4 å¦‚æœ then ä¸æ˜¯å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise</span></span><br><span class="line">            resolve(x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 2.3.4 å¦‚æœ x ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise</span></span><br><span class="line">        <span class="keyword">return</span> resolve(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="å…«ã€Promises-A-æµ‹è¯•"><a href="#å…«ã€Promises-A-æµ‹è¯•" class="headerlink" title="å…«ã€Promises/A+ æµ‹è¯•"></a>å…«ã€Promises/A+ æµ‹è¯•</h1><p>å¦‚ä½•è¯æ˜æˆ‘ä»¬å†™çš„<code>myPromise</code>å°±ç¬¦åˆ <strong>Promises/A+</strong> è§„èŒƒå‘¢ï¼Ÿ</p>
<p>è·‘ä¸€ä¸‹ Promise A+ æµ‹è¯• å°±å¥½å•¦~</p>
<h2 id="1-å®‰è£…å®˜æ–¹æµ‹è¯•å·¥å…·"><a href="#1-å®‰è£…å®˜æ–¹æµ‹è¯•å·¥å…·" class="headerlink" title="1. å®‰è£…å®˜æ–¹æµ‹è¯•å·¥å…·"></a>1. å®‰è£…å®˜æ–¹æµ‹è¯•å·¥å…·</h2><p>æˆ‘ä»¬ä½¿ç”¨Promises/A+å®˜æ–¹çš„æµ‹è¯•å·¥å…· <a class="link"   target="_blank" rel="noopener" href="https://github.com/promises-aplus/promises-tests" >promises-aplus-tests<i class="fas fa-external-link-alt"></i></a> æ¥å¯¹æˆ‘ä»¬çš„<code>myPromise</code>è¿›è¡Œæµ‹è¯•</p>
<p><strong>å®‰è£… <code>promises-aplus-tests</code>:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install promises-aplus-tests -D</span><br></pre></td></tr></table></figure>

<p><strong>å®‰è£…å®Œæµ‹è¯•å·¥å…·åçš„é¡¹ç›®ç›®å½•ï¼š</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/02/08/JS-Promise%E7%9A%84%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/1.png"
                      class=""
                >

<h2 id="2-ä½¿ç”¨-CommonJS-å¯¹å¤–æš´éœ²-myPromise-ç±»"><a href="#2-ä½¿ç”¨-CommonJS-å¯¹å¤–æš´éœ²-myPromise-ç±»" class="headerlink" title="2. ä½¿ç”¨ CommonJS å¯¹å¤–æš´éœ² myPromise ç±»"></a>2. ä½¿ç”¨ CommonJS å¯¹å¤–æš´éœ² myPromise ç±»</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2, x, resolve, reject</span>) </span>&#123; </span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ <span class="built_in">module</span>.exports = myPromise;</span><br></pre></td></tr></table></figure>

<h2 id="3-å®ç°é™æ€æ–¹æ³•-deferred"><a href="#3-å®ç°é™æ€æ–¹æ³•-deferred" class="headerlink" title="3. å®ç°é™æ€æ–¹æ³• deferred"></a>3. å®ç°é™æ€æ–¹æ³• deferred</h2><p>è¦ä½¿ç”¨ <code>promises-aplus-tests</code> è¿™ä¸ªå·¥å…·æµ‹è¯•ï¼Œå¿…é¡»å®ç°ä¸€ä¸ªé™æ€æ–¹æ³•<code>deferred()</code>ï¼Œå®˜æ–¹å¯¹è¿™ä¸ªæ–¹æ³•çš„å®šä¹‰å¦‚ä¸‹:</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/02/08/JS-Promise%E7%9A%84%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f38323263326466356230323934623535393964303339313335383034623730662e706e67.png"
                      class=""
                >

<p>æ„æ€å°±æ˜¯ï¼š</p>
<p>æˆ‘ä»¬è¦ç»™è‡ªå·±æ‰‹å†™çš„<code>myPromise</code>ä¸Šå®ç°ä¸€ä¸ªé™æ€æ–¹æ³•<code>deferred()</code>ï¼Œè¯¥æ–¹æ³•è¦è¿”å›ä¸€ä¸ªåŒ…å«<code>&#123; promise, resolve, reject &#125;</code>çš„å¯¹è±¡ï¼š</p>
<ul>
<li><code>promise</code> æ˜¯ä¸€ä¸ªå¤„äº<code>pending</code>çŠ¶æ€çš„ Promsieã€‚</li>
<li><code>resolve(value)</code> ç”¨<code>value</code>è§£å†³ä¸Šé¢é‚£ä¸ª<code>promise</code></li>
<li><code>reject(reason)</code> ç”¨<code>reason</code>æ‹’ç»ä¸Šé¢é‚£ä¸ª<code>promise</code></li>
</ul>
<p><strong><code>deferred()</code>çš„å®ç°å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myPromise</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2, x, resolve, reject</span>) </span>&#123; </span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+  myPromise.deferred = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">+      <span class="keyword">let</span> result = &#123;&#125;;</span><br><span class="line">+      result.promise = <span class="keyword">new</span> myPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">+          result.resolve = resolve;</span><br><span class="line">+          result.reject = reject;</span><br><span class="line">+      &#125;);</span><br><span class="line">+      <span class="keyword">return</span> result;</span><br><span class="line">+  &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = myPromise;</span><br></pre></td></tr></table></figure>

<h2 id="4-é…ç½®-package-json"><a href="#4-é…ç½®-package-json" class="headerlink" title="4. é…ç½® package.json"></a>4. é…ç½® package.json</h2><p>æˆ‘ä»¬å®ç°äº†<code>deferred </code>æ–¹æ³•ï¼Œä¹Ÿé€šè¿‡ CommonJS å¯¹å¤–æš´éœ²äº†<code>myPromise</code>ï¼Œæœ€åé…ç½®ä¸€ä¸‹<code>package.json</code>å°±å¯ä»¥è·‘æµ‹è¯•å•¦~ğŸ˜º</p>
<p>æ–°å»ºä¸€ä¸ª <code>package.json</code> ï¼Œ<strong>é…ç½®å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// package.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;devDependencies&quot;: &#123;</span><br><span class="line">    &quot;promises-aplus-tests&quot;: &quot;^2.1.2&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;test&quot;: &quot;promises-aplus-tests myPromise&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>é¡¹ç›®ç›®å½•ï¼š</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/02/08/JS-Promise%E7%9A%84%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/68747470733a2f2f696d672d626c6f672e6373646e696d671.png"
                      class=""
                >

<h2 id="5-å®Œç¾é€šè¿‡å®˜æ–¹872ä¸ªæµ‹è¯•ç”¨ä¾‹"><a href="#5-å®Œç¾é€šè¿‡å®˜æ–¹872ä¸ªæµ‹è¯•ç”¨ä¾‹" class="headerlink" title="5. å®Œç¾é€šè¿‡å®˜æ–¹872ä¸ªæµ‹è¯•ç”¨ä¾‹"></a>5. å®Œç¾é€šè¿‡å®˜æ–¹872ä¸ªæµ‹è¯•ç”¨ä¾‹</h2><p><strong>æ‰§è¡Œæµ‹è¯•å‘½ä»¤ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run test</span><br></pre></td></tr></table></figure>

<p>Promises/A+ å®˜æ–¹æµ‹è¯•æ€»å…±872ç”¨ä¾‹ï¼Œæˆ‘ä»¬æ‰‹å†™çš„Promiseå®Œç¾é€šè¿‡äº†æ‰€æœ‰ç”¨ä¾‹ ğŸ‰ğŸ‰ğŸ‰:</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/02/08/JS-Promise%E7%9A%84%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/image-20220208161458663.png"
                      class="" title="image-20220208161458663"
                >

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>Post titleï¼šJSæ·±å…¥å­¦ä¹ (20)ï¼šPromiseçš„æ¨¡æ‹Ÿå®ç°</li>
        <li>Post authorï¼šSunburst7</li>
        <li>Create timeï¼š2022-02-08 15:24:04</li>
        <li>
            Post linkï¼šhttps://sunburst7.github.io/2022/02/08/JS-Promiseçš„æ¨¡æ‹Ÿå®ç°/
        </li>
        <li>
            Copyright Noticeï¼šAll articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/JavaScript/">#JavaScript</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E5%89%8D%E7%AB%AF/">#å‰ç«¯</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0/">#æ¨¡æ‹Ÿå®ç°</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2022/02/10/JS-Proxy/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">JSæ·±å…¥å­¦ä¹ (21)ï¼šProxyä¸Reflect</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2022/02/05/leetcode-%E6%89%80%E6%9C%89%E5%8F%AF%E8%83%BD%E7%9A%84%E8%B7%AF%E5%BE%84/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">leetcode(8)æ‰€æœ‰å¯èƒ½çš„è·¯å¾„</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2021</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Sunburst7</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%AE%9A%E4%B9%89%E5%88%9D%E5%A7%8B%E7%BB%93%E6%9E%84"><span class="nav-text">ä¸€ã€å®šä¹‰åˆå§‹ç»“æ„</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%AE%9E%E7%8E%B0-resolve-%E5%92%8C-reject"><span class="nav-text">äºŒã€å®ç° resolve å’Œ reject</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%AE%A1%E7%90%86%E7%8A%B6%E6%80%81%E5%92%8C%E7%BB%93%E6%9E%9C"><span class="nav-text">1. ç®¡ç†çŠ¶æ€å’Œç»“æœ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-this-%E6%8C%87%E5%90%91%E9%97%AE%E9%A2%98"><span class="nav-text">2. this æŒ‡å‘é—®é¢˜</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%AE%9E%E7%8E%B0-then-%E6%96%B9%E6%B3%95"><span class="nav-text">ä¸‰ã€å®ç° then æ–¹æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%8A%B6%E6%80%81%E4%B8%8D%E5%8F%AF%E5%8F%98"><span class="nav-text">1. çŠ¶æ€ä¸å¯å˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%89%A7%E8%A1%8C%E5%BC%82%E5%B8%B8-throw"><span class="nav-text">2. æ‰§è¡Œå¼‚å¸¸ throw</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C"><span class="nav-text">3. å‚æ•°æ ¡éªŒ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5"><span class="nav-text">å››ã€å®ç°å¼‚æ­¥</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%B7%BB%E5%8A%A0%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="nav-text">1. æ·»åŠ å®šæ—¶å™¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%9B%9E%E8%B0%83%E4%BF%9D%E5%AD%98"><span class="nav-text">2. å›è°ƒä¿å­˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%AA%8C%E8%AF%81-then-%E6%96%B9%E6%B3%95%E5%A4%9A%E6%AC%A1%E8%B0%83%E7%94%A8"><span class="nav-text">3. éªŒè¯ then æ–¹æ³•å¤šæ¬¡è°ƒç”¨</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%AE%9E%E7%8E%B0-then-%E6%96%B9%E6%B3%95%E7%9A%84%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="nav-text">äº”ã€å®ç° then æ–¹æ³•çš„é“¾å¼è°ƒç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Promises-A-%E8%A7%84%E8%8C%83%E7%9A%84%E7%90%86%E8%A7%A3"><span class="nav-text">1. Promises&#x2F;A+ è§„èŒƒçš„ç†è§£</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Promises-A-%E8%A7%84%E8%8C%83%E7%9A%84%E6%80%BB%E7%BB%93"><span class="nav-text">2. Promises&#x2F;A+ è§„èŒƒçš„æ€»ç»“</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-then-%E6%96%B9%E6%B3%95%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84Promise"><span class="nav-text">3. then æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promise</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%AE%9E%E7%8E%B0-resolvePromise-%E6%96%B9%E6%B3%95"><span class="nav-text">å…­ã€å®ç° resolvePromise æ–¹æ³•</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E5%AE%8C%E6%95%B4%E7%9A%84-Promises-A-%E5%AE%9E%E7%8E%B0"><span class="nav-text">ä¸ƒã€å®Œæ•´çš„ Promises&#x2F;A+ å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%B8%85%E7%88%BD%E7%AE%80%E6%B4%81-%E6%97%A0%E6%B3%A8%E9%87%8A%E7%89%88"><span class="nav-text">1. æ¸…çˆ½ç®€æ´ æ— æ³¨é‡Šç‰ˆ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%8C%89%E6%AD%A5%E5%88%86%E6%9E%90-%E6%B3%A8%E9%87%8A%E5%8A%A0%E6%8C%81%E7%89%88"><span class="nav-text">2. æŒ‰æ­¥åˆ†æ æ³¨é‡ŠåŠ æŒç‰ˆ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81Promises-A-%E6%B5%8B%E8%AF%95"><span class="nav-text">å…«ã€Promises&#x2F;A+ æµ‹è¯•</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%AE%89%E8%A3%85%E5%AE%98%E6%96%B9%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="nav-text">1. å®‰è£…å®˜æ–¹æµ‹è¯•å·¥å…·</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8-CommonJS-%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2-myPromise-%E7%B1%BB"><span class="nav-text">2. ä½¿ç”¨ CommonJS å¯¹å¤–æš´éœ² myPromise ç±»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%AE%9E%E7%8E%B0%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95-deferred"><span class="nav-text">3. å®ç°é™æ€æ–¹æ³• deferred</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E9%85%8D%E7%BD%AE-package-json"><span class="nav-text">4. é…ç½® package.json</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%AE%8C%E7%BE%8E%E9%80%9A%E8%BF%87%E5%AE%98%E6%96%B9872%E4%B8%AA%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="nav-text">5. å®Œç¾é€šè¿‡å®˜æ–¹872ä¸ªæµ‹è¯•ç”¨ä¾‹</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/code-copy.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/lazyload.js"></script>


<div class="post-scripts">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/toc.js"></script>
    
</div>



</body>
</html>
